<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>金融管理系统</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 统一的 Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e88e5',
                        secondary: '#64b5f6',
                        accent: '#0d47a1',
                        neutral: '#f5f7fa',
                        'neutral-dark': '#e1e8ed'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                        'card-hover': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .glass-effect {
                background: rgba(255, 255, 255, 0.7);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }
            .transition-all-300 {
                transition: all 0.3s ease;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
        }
    </style>
    <style>
        /* 自定义动画 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fadeIn {
            animation: fadeIn 0.3s ease forwards;
        }
        
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }
        
        /* 卡片悬停效果 */
        .collection-card {
            transition: all 0.3s ease;
        }
        
        .collection-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* 图片上传预览样式 */
        .image-preview {
            position: relative;
            width: 100%;
            height: 200px;
            border: 2px dashed #cbd5e0;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .image-preview.has-image {
            border-style: solid;
            border-color: #1e88e5;
        }
        
        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .image-preview .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(255, 255, 255, 0.8);
            color: #e53e3e;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .image-preview:hover .remove-image {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-neutral min-h-screen flex flex-col">
    <div id="login-screen" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md animate-fadeIn">
            <div class="p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">登入</h3>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-1">名稱</label>
                        <input type="text" id="login-username" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-1">密碼</label>
                        <div class="flex items-center space-x-2">
                            <input type="password" id="login-password" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
                            <button type="button" id="toggle-password" class="px-3 py-2 border border-gray-300 rounded-md text-gray-700">顯示</button>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <input type="checkbox" id="remember-me" class="mr-2">
                            <label for="remember-me" class="text-gray-700">記住我（本設備一小時免密）</label>
                        </div>
                        <button type="submit" class="px-4 py-2 bg-primary text-white rounded-md">登入</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- 顶部导航栏 -->
    <header id="app-header" class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <button id="hamburger-btn" class="mr-2 p-2 text-gray-600 hover:text-primary">
                    <i class="fa fa-bars"></i>
                </button>
                <i class="fa fa-diamond text-primary text-2xl"></i>
                <h1 class="text-xl font-bold text-gray-800" data-i18n="appTitle">收藏品管理系统</h1>
            </div>
            <div class="flex space-x-3">
                <button id="add-category-btn" class="flex items-center px-4 py-2 bg-primary text-white rounded-md hover:bg-accent transition-all-300">
                    <i class="fa fa-plus mr-2"></i>
                    <span data-i18n="addCategory">添加分类</span>
                </button>
                <button id="add-item-btn" class="flex items-center px-4 py-2 bg-white border border-primary text-primary rounded-md hover:bg-blue-50 transition-all-300">
                    <i class="fa fa-plus mr-2"></i>
                    <span data-i18n="addItem">添加商品</span>
                </button>
                <button id="settings-btn" class="flex items-center px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-all-300">
                    <i class="fa fa-cog mr-2"></i>
                    <span data-i18n="settings">设置</span>
                </button>
            </div>
        </div>
</header>

    <!-- 主内容区 -->
    <main id="app-main" class="flex-1 flex">
        <!-- 登錄模態框 -->
        <div id="login-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
            <div class="modal-backdrop absolute inset-0" ></div>
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md z-10 animate-fadeIn">
                <div class="p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">登入</h3>
                    <form id="login-form" class="space-y-4">
                        <div>
                            <label class="block text-gray-700 font-medium mb-1">名稱</label>
                            <input type="text" id="login-username" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-1">密碼</label>
                            <div class="flex items-center space-x-2">
                                <input type="password" id="login-password" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
                                <button type="button" id="toggle-password" class="px-3 py-2 border border-gray-300 rounded-md text-gray-700">顯示</button>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <input type="checkbox" id="remember-me" class="mr-2">
                                <label for="remember-me" class="text-gray-700">記住我（本設備一小時免密）</label>
                            </div>
                            <button type="submit" class="px-4 py-2 bg-primary text-white rounded-md">登入</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- 左侧分类导航 -->
        <aside id="sidebar" class="w-64 bg-white shadow-md hidden md:block">
            <div class="p-4">
                <h2 class="text-lg font-semibold text-gray-700 mb-3" data-i18n="categories">分类</h2>
                <div class="space-y-1">
                    <button class="w-full text-left px-3 py-2 rounded-md bg-blue-50 text-primary font-medium flex justify-between items-center">
                        <span data-i18n="allCollections">全部藏品</span>
                        <span id="total-count" class="bg-primary text-white text-xs px-2 py-1 rounded-full">0</span>
                    </button>
                    <div id="categories-list" class="mt-2 space-y-1">
                        <!-- 分类列表将通过 JavaScript 动态生成 -->
                    </div>
                </div>
            </div>
            
            <div class="p-4 border-t border-gray-200">
                <h2 class="text-lg font-semibold text-gray-700 mb-3">记账</h2>
                <div class="space-y-1">
                    <button id="expense-list-btn" class="w-full text-left px-3 py-2 rounded-md bg-blue-50 text-primary font-medium flex items-center">
                        <i class="fa fa-list-ul text-red-500 mr-2"></i>
                        <span>支出记录</span>
                    </button>
                    <button id="income-list-btn" class="w-full text-left px-3 py-2 rounded-md hover:bg-blue-50 text-gray-700 font-medium flex items-center">
                        <i class="fa fa-list-ul text-green-500 mr-2"></i>
                        <span>收入记录</span>
                    </button>
                    <button id="statistics-btn" class="w-full text-left px-3 py-2 rounded-md hover:bg-blue-50 text-gray-700 font-medium flex items-center">
                        <i class="fa fa-bar-chart text-blue-500 mr-2"></i>
                        <span>统计分析</span>
                    </button>
                    <button id="budget-manage-btn" class="w-full text-left px-3 py-2 rounded-md hover:bg-blue-50 text-gray-700 font-medium flex items-center">
                        <i class="fa fa-money text-blue-500 mr-2"></i>
                        <span>管理预算</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- 移动抽屉遮罩层 -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-30 hidden z-40"></div>
        
        <!-- 右侧内容区 -->
        <div class="flex-1 p-4 md:p-6 overflow-auto">
            <div id="content-area" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div id="main-content" class="lg:col-span-2">
                <!-- 欢迎页面 -->
                <div id="welcome-screen" class="flex flex-col items-center justify-center h-full">
                    <div class="text-center">
                        <img src="https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/0afab40b669d4b238359d64f3969239f~tplv-a9rns2rl98-image.image?rcl=202512061312199E0257F5891BC70005F7&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1767589964&x-signature=Ynxfdw7hqeDgWh09GenIybLM2TY%3D" 
                             alt="收藏品管理系统" 
                             class="w-64 h-auto mx-auto mb-6 opacity-80">
                        <h2 class="text-2xl font-bold text-gray-700 mb-2" data-i18n="welcomeTitle">欢迎使用收藏品管理系统</h2>
                        <p class="text-gray-500 mb-6" data-i18n="welcomeSubtitle">开始管理您的收藏品，创建分类并添加商品</p>
                        <div class="flex justify-center space-x-4">
                            <button id="welcome-add-category-btn" class="px-6 py-2 bg-primary text-white rounded-md hover:bg-accent transition-all-300">
                                <i class="fa fa-plus mr-2"></i><span data-i18n="addCategory">添加分类</span>
                            </button>
                            <button id="welcome-add-item-btn" class="px-6 py-2 bg-white border border-primary text-primary rounded-md hover:bg-blue-50 transition-all-300">
                                <i class="fa fa-plus mr-2"></i><span data-i18n="addItem">添加商品</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 分类内容页面 -->
                <div id="category-content" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 id="current-category-name" class="text-2xl font-bold text-gray-800">全部藏品</h2>
                        <div class="flex space-x-3">
                            <div class="relative">
                                <input type="text" id="search-input" placeholder="搜索藏品..." data-i18n-placeholder="searchPlaceholder" class="pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <i class="fa fa-search absolute left-3 top-3 text-gray-400"></i>
                            </div>
                            <select id="sort-select" class="px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="name" data-i18n="sortByName">按名称排序</option>
                                <option value="createdAt" data-i18n="sortByDate">按创建时间排序</option>
                            </select>
                        </div>
                    </div>

                    <!-- 藏品网格 -->
                    <div id="items-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                        <!-- 藏品卡片将通过 JavaScript 动态生成 -->
                    </div>

                    <!-- 空状态 -->
                    <div id="empty-state" class="hidden flex flex-col items-center justify-center py-16">
                        <div class="bg-blue-50 rounded-full p-6 mb-4">
                            <i class="fa fa-inbox text-primary text-4xl"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-700 mb-2" data-i18n="noItems">暂无藏品</h3>
                        <p class="text-gray-500 mb-6" data-i18n="addItemToCategory">该分类下还没有藏品，点击"添加商品"按钮添加</p>
                        <button id="empty-add-item-btn" class="px-6 py-2 bg-primary text-white rounded-md hover:bg-accent transition-all-300">
                            <i class="fa fa-plus mr-2"></i><span data-i18n="addItem">添加商品</span>
                        </button>
                    </div>
                </div>
                </div>
                <!-- 右侧面板：显示交易记录与统计 -->
                <aside id="right-panel" class="hidden lg:block space-y-6 lg:col-span-1">
                    <!-- 交易记录列表视图（右侧） -->
                    <div id="transactions-list-view" class="hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 id="transactions-list-title" class="text-2xl font-bold text-gray-800">支出记录</h2>
                            <div class="flex space-x-3">
                                <button id="add-transaction-btn" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-accent transition-all-300">
                                    <i class="fa fa-plus mr-2"></i>添加记录
                                </button>
                            </div>
                        </div>

                        <!-- 交易记录表格 -->
                        <div class="bg-white rounded-lg shadow-md overflow-hidden">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">分类</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">金额</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">备注</th>
                                        <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="transactions-list-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- 交易记录将通过 JavaScript 动态生成 -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 统计分析视图（右侧） -->
                    <div id="statistics-view" class="hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">统计分析</h2>
                            <div class="flex space-x-3">
                                <select id="statistics-period" class="px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <option value="month">本月</option>
                                    <option value="year">本年</option>
                                    <option value="all">全部</option>
                                </select>
                            </div>
                        </div>

                        <!-- 统计卡片 -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                            <div class="bg-white rounded-lg shadow-md p-4">
                                <h3 class="text-gray-500 text-sm mb-1">总收入</h3>
                                <p id="total-income" class="text-2xl font-bold text-green-500">¥0.00</p>
                            </div>
                            <div class="bg-white rounded-lg shadow-md p-4">
                                <h3 class="text-gray-500 text-sm mb-1">总支出</h3>
                                <p id="total-expense" class="text-2xl font-bold text-red-500">¥0.00</p>
                            </div>
                            <div class="bg-white rounded-lg shadow-md p-4">
                                <h3 class="text-gray-500 text-sm mb-1">结余</h3>
                                <p id="total-balance" class="text-2xl font-bold text-blue-500">¥0.00</p>
                            </div>
                        </div>

                        <!-- 最近交易记录 -->
                        <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
                            <div class="px-4 py-3 border-b border-gray-200">
                                <h3 class="text-lg font-medium text-gray-800">最近交易记录</h3>
                            </div>
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">类型</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">分类</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">金额</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">备注</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-transactions-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- 最近交易记录将通过 JavaScript 动态生成 -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 管理预算视图（右侧，全屏模式） -->
                    <div id="budget-view" class="hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800" data-i18n="budgetManagement">管理预算</h2>
                            <div class="flex space-x-3">
                                <button id="quick-add-budget-btn" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-accent transition-all-300">
                                    <i class="fa fa-plus mr-2"></i><span data-i18n="addBudget">新增预算</span>
                                </button>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow-md overflow-hidden">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="budgetName">预算名称</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="budgetType">预算类型</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="budgetAmount">预算金额</th>
                                        <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="actions">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="budgets-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                        <div id="quick-add-budget-form" class="mt-4 bg-gray-50 p-3 rounded-lg hidden">
                            <form>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <div>
                                        <label for="budget-name" class="block text-gray-700 text-sm font-medium mb-1" data-i18n="budgetName">预算名称</label>
                                        <input type="text" id="budget-name" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                    </div>
                                    <div>
                                        <label for="budget-type" class="block text-gray-700 text-sm font-medium mb-1" data-i18n="budgetType">预算类型</label>
                                        <input type="text" id="budget-type" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                    </div>
                                    <div>
                                        <label for="budget-amount" class="block text-gray-700 text-sm font-medium mb-1" data-i18n="budgetAmount">预算金额</label>
                                        <input type="number" id="budget-amount" step="0.01" min="0" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                    </div>
                                </div>
                                <div class="mt-3 flex justify-end space-x-2">
                                    <button type="button" id="cancel-quick-add-budget" class="px-3 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-100 transition-all-300" data-i18n="cancel">取消</button>
                                    <button type="submit" class="px-3 py-2 bg-primary text-white rounded-md hover:bg-accent transition-all-300" data-i18n="save">保存</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
    </main>

    <!-- 底部状态栏 -->
    <footer class="bg-white border-t border-gray-200 py-3">
        <div class="container mx-auto px-4 flex justify-between items-center text-sm text-gray-600">
            <div>收藏品管理系统 © 2025</div>
            <div id="status-bar" class="text-primary"></div>
        </div>
    </footer>

    <!-- 添加分类模态框 -->
    <div id="add-category-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="modal-backdrop absolute inset-0" onclick="closeModal('add-category-modal')"></div>
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md z-10 animate-fadeIn max-h-[80vh] overflow-y-auto">
            <div class="p-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xl font-bold text-gray-800" data-i18n="addCategory">添加分类</h3>
                    <button onclick="closeModal('add-category-modal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <form id="add-category-form">
                    <div class="mb-3">
                        <label for="category-name" class="block text-gray-700 font-medium mb-1" data-i18n="categoryName">分类名称</label>
                        <input type="text" id="category-name" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                    <div class="mb-3">
                        <label for="category-description" class="block text-gray-700 font-medium mb-1" data-i18n="categoryDescription">分类描述（可选）</label>
                        <textarea id="category-description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeModal('add-category-modal')" class="px-3 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-all-300" data-i18n="cancel">
                            取消
                        </button>
                        <button type="submit" class="px-3 py-2 bg-primary text-white rounded-md hover:bg-accent transition-all-300" data-i18n="save">
                            保存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 添加商品模态框 -->
    <div id="add-item-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="modal-backdrop absolute inset-0" onclick="closeModal('add-item-modal')"></div>
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl z-10 animate-fadeIn max-h-[80vh] overflow-y-auto">
            <div class="p-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xl font-bold text-gray-800" data-i18n="addItem">添加商品</h3>
                    <button onclick="closeModal('add-item-modal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <form id="add-item-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <div>
                            <label for="item-category" class="block text-gray-700 font-medium mb-1" data-i18n="itemCategory">所属分类</label>
                            <select id="item-category" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <!-- 分类选项将通过 JavaScript 动态生成 -->
                            </select>
                        </div>
                        <div>
                            <label for="item-name" class="block text-gray-700 font-medium mb-1" data-i18n="itemName">商品名称</label>
                            <input type="text" id="item-name" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <div>
                            <label for="item-currency" class="block text-gray-700 font-medium mb-1" data-i18n="itemCurrency">币种</label>
                            <select id="item-currency" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="">请选择币种</option>
                            </select>
                        </div>
                        <div>
                            <label for="item-denomination" class="block text-gray-700 font-medium mb-1" data-i18n="itemDenomination">面额</label>
                            <input type="text" id="item-denomination" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="item-collection-type" class="block text-gray-700 font-medium mb-1" data-i18n="itemCollectionType">收藏类型</label>
                        <input id="item-collection-type" list="collection-type-list" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" />
                        <datalist id="collection-type-list"></datalist>
                    </div>
                    <div class="mb-3">
                        <label for="item-serial-number" class="block text-gray-700 font-medium mb-1">号码</label>
                        <input type="text" id="item-serial-number" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                    <div class="mb-3">
                        <label for="item-code" class="block text-gray-700 font-medium mb-1">商品编号</label>
                        <div class="flex items-center space-x-2">
                            <input type="text" id="item-code" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <label class="flex items-center space-x-1">
                                <input type="checkbox" id="auto-code" class="mr-1">
                                <span>自动编号</span>
                            </label>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 font-medium mb-1" data-i18n="uploadImage">上传照片</label>
                        <div class="image-preview" id="image-preview">
                            <input type="file" id="item-image" accept="image/*" multiple class="hidden">
                            <div id="preview-placeholder" class="text-center">
                                <i class="fa fa-cloud-upload text-gray-400 text-3xl mb-2"></i>
                                <p class="text-gray-500" data-i18n="clickOrDrag">点击或拖拽图片到此处上传（最多3张）</p>
                            </div>
                            <img id="preview-image" src="" alt="预览" class="hidden">
                            <div class="remove-image hidden" onclick="removeImage()">
                                <i class="fa fa-times"></i>
                            </div>
                        </div>
                        <div id="preview-thumbs" class="grid grid-cols-3 gap-2 mt-2"></div>
                    </div>
                    <div class="mb-4">
                        <label for="item-notes" class="block text-gray-700 font-medium mb-1" data-i18n="itemNotes">备注（可选）</label>
                        <textarea id="item-notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeModal('add-item-modal')" class="px-3 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-all-300" data-i18n="cancel">
                            取消
                        </button>
                        <button type="submit" class="px-3 py-2 bg-primary text-white rounded-md hover:bg-accent transition-all-300" data-i18n="save">
                            保存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 查看商品详情模态框 -->
    <div id="item-detail-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="modal-backdrop absolute inset-0" onclick="closeModal('item-detail-modal')"></div>
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl z-10 animate-fadeIn max-h-[80vh] overflow-y-auto">
            <div class="p-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xl font-bold text-gray-800">商品详情</h3>
                    <button onclick="closeModal('item-detail-modal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <div class="bg-gray-100 rounded-lg p-2 h-80 flex items-center justify-center">
                            <img id="detail-image" src="" alt="商品图片" class="max-w-full max-h-full object-contain">
                        </div>
                    </div>
                    <div>
                        <div class="space-y-4">
                            <div>
                                <h4 class="text-gray-500 text-sm">商品名称</h4>
                                <p id="detail-name" class="text-xl font-semibold text-gray-800"></p>
                            </div>
                            <div>
                                <h4 class="text-gray-500 text-sm">所属分类</h4>
                                <p id="detail-category" class="text-gray-800"></p>
                            </div>
                            <div>
                                <h4 class="text-gray-500 text-sm">币种</h4>
                                <p id="detail-currency" class="text-gray-800"></p>
                            </div>
                            <div>
                                <h4 class="text-gray-500 text-sm">收藏类型</h4>
                                <p id="detail-collection-type" class="text-gray-800"></p>
                            </div>
                            <div>
                                <h4 class="text-gray-500 text-sm">面额</h4>
                                <p id="detail-denomination" class="text-gray-800"></p>
                            </div>
                            <div>
                                <h4 class="text-gray-500 text-sm">号码</h4>
                                <p id="detail-serial-number" class="text-gray-800"></p>
                            </div>
                            <div>
                                <h4 class="text-gray-500 text-sm">备注</h4>
                                <p id="detail-notes" class="text-gray-800"></p>
                            </div>
                            <div>
                                <h4 class="text-gray-500 text-sm">创建时间</h4>
                                <p id="detail-created-at" class="text-gray-800"></p>
                            </div>
                        </div>
                        <div class="mt-6 flex space-x-3">
                            <button id="edit-item-btn" class="px-4 py-2 border border-primary text-primary rounded-md hover:bg-blue-50 transition-all-300">
                                <i class="fa fa-pencil mr-2"></i>编辑
                            </button>
                            <button id="delete-item-btn" class="px-4 py-2 border border-red-500 text-red-500 rounded-md hover:bg-red-50 transition-all-300">
                                <i class="fa fa-trash mr-2"></i>删除
                            </button>
                        </div>
                    </div>
                </div>
                

            </div>
        </div>
    </div>

    <!-- 编辑商品模态框 -->
    <div id="edit-item-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="modal-backdrop absolute inset-0" onclick="closeModal('edit-item-modal')"></div>
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl z-10 animate-fadeIn max-h-[80vh] overflow-y-auto">
            <div class="p-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xl font-bold text-gray-800">编辑商品</h3>
                    <button onclick="closeModal('edit-item-modal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <form id="edit-item-form">
                    <input type="hidden" id="edit-item-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <div>
                            <label for="edit-item-category" class="block text-gray-700 font-medium mb-2">所属分类</label>
                            <select id="edit-item-category" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <!-- 分类选项将通过 JavaScript 动态生成 -->
                            </select>
                        </div>
                        <div>
                            <label for="edit-item-name" class="block text-gray-700 font-medium mb-2">商品名称</label>
                            <input type="text" id="edit-item-name" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <div>
                            <label for="edit-item-currency" class="block text-gray-700 font-medium mb-2">币种</label>
                            <select id="edit-item-currency" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="">请选择币种</option>
                            </select>
                        </div>
                        <div>
                            <label for="edit-item-denomination" class="block text-gray-700 font-medium mb-2">面额</label>
                            <input type="text" id="edit-item-denomination" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="edit-item-collection-type" class="block text-gray-700 font-medium mb-1">收藏类型</label>
                        <input id="edit-item-collection-type" list="edit-collection-type-list" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" />
                        <datalist id="edit-collection-type-list"></datalist>
                    </div>
                    <div class="mb-3">
                        <label for="edit-item-serial-number" class="block text-gray-700 font-medium mb-1">号码</label>
                        <input type="text" id="edit-item-serial-number" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 font-medium mb-1" data-i18n="uploadImage">上传照片</label>
                        <div class="image-preview" id="edit-image-preview">
                            <input type="file" id="edit-item-image" accept="image/*" multiple class="hidden">
                            <div id="edit-preview-placeholder" class="text-center">
                                <i class="fa fa-cloud-upload text-gray-400 text-3xl mb-2"></i>
                                <p class="text-gray-500" data-i18n="clickOrDrag">点击或拖拽图片到此处上传</p>
                            </div>
                            <img id="edit-preview-image" src="" alt="预览" class="hidden">
                            <div class="remove-image hidden" onclick="removeEditImage()">
                                <i class="fa fa-times"></i>
                            </div>
                        </div>
                        <div id="edit-preview-thumbs" class="grid grid-cols-3 gap-2 mt-2"></div>
                    </div>
                    <div class="mb-4">
                        <label for="edit-item-notes" class="block text-gray-700 font-medium mb-1">备注（可选）</label>
                        <textarea id="edit-item-notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeModal('edit-item-modal')" class="px-3 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-all-300">
                            取消
                        </button>
                        <button type="submit" class="px-3 py-2 bg-primary text-white rounded-md hover:bg-accent transition-all-300">
                            保存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 确认删除模态框 -->
    <div id="confirm-delete-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="modal-backdrop absolute inset-0" onclick="closeModal('confirm-delete-modal')"></div>
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md z-10 animate-fadeIn">
            <div class="p-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xl font-bold text-gray-800">确认删除</h3>
                    <button onclick="closeModal('confirm-delete-modal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <div class="mb-4">
                    <p class="text-gray-700">您确定要删除这个项目吗？此操作无法撤销。</p>
                    <p id="delete-item-name" class="font-medium text-gray-800 mt-2"></p>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeModal('confirm-delete-modal')" class="px-3 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-all-300">
                        取消
                    </button>
                    <button type="button" id="confirm-delete-btn" class="px-3 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-all-300">
                        确认删除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 设置模态框 -->
    <div id="settings-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="modal-backdrop absolute inset-0" onclick="closeModal('settings-modal')"></div>
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl z-10 animate-fadeIn max-h-[80vh] overflow-y-auto">
            <div class="p-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xl font-bold text-gray-800">设置</h3>
                    <button onclick="closeModal('settings-modal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                
                <!-- 设置选项卡 -->
                <div class="border-b border-gray-200 mb-4">
                    <ul class="flex flex-wrap -mb-px" id="settings-tabs" role="tablist">
                        <li class="mr-2" role="presentation">
                            <button class="inline-block p-2 border-b-2 border-primary text-primary rounded-t-lg" id="categories-tab" data-tab="categories" type="button" role="tab">
                                <i class="fa fa-folder mr-2"></i><span data-i18n="manageCategories">管理分类</span>
                            </button>
                        </li>
                        <li class="mr-2" role="presentation">
                            <button class="inline-block p-2 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 rounded-t-lg" id="items-tab" data-tab="items" type="button" role="tab">
                                <i class="fa fa-cubes mr-2"></i><span data-i18n="manageItems">管理商品</span>
                            </button>
                        </li>
                        <li class="mr-2" role="presentation">
                            <button class="inline-block p-2 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 rounded-t-lg" id="types-tab" data-tab="types" type="button" role="tab">
                                <i class="fa fa-tags mr-2"></i>管理收藏类型
                            </button>
                        </li>
                        <li class="mr-2" role="presentation">
                            <button class="inline-block p-2 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 rounded-t-lg" id="expense-cats-tab" data-tab="expense-cats" type="button" role="tab">
                                <i class="fa fa-minus-circle mr-2"></i>管理支出分类
                            </button>
                        </li>
                        <li class="mr-2" role="presentation">
                            <button class="inline-block p-2 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 rounded-t-lg" id="income-cats-tab" data-tab="income-cats" type="button" role="tab">
                                <i class="fa fa-plus-circle mr-2"></i>管理收入分类
                            </button>
                        </li>
                        <li class="mr-2" role="presentation">
                            <button class="inline-block p-2 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 rounded-t-lg" id="display-tab" data-tab="display" type="button" role="tab">
                                <i class="fa fa-mobile mr-2"></i>显示方式
                            </button>
                        </li>
                        <li class="mr-2" role="presentation">
                            <button class="inline-block p-2 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 rounded-t-lg" id="currencies-tab" data-tab="currencies" type="button" role="tab">
                                <i class="fa fa-money mr-2"></i>管理币种
                            </button>
                        </li>
                        <li class="mr-2" role="presentation">
                            <button class="inline-block p-2 border-b-2 border-primary text-primary rounded-t-lg" id="language-tab" data-tab="language" type="button" role="tab">
                                <i class="fa fa-language mr-2"></i><span data-i18n="languageSettings">语言设置</span>
                            </button>
                        </li>
                    </ul>
                </div>
                
                <!-- 管理分类内容 -->
                <div id="categories-tab-content" class="tab-content active">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-medium text-gray-800">分类列表</h4>
                        <button id="quick-add-category-btn" class="flex items-center px-3 py-1 bg-primary text-white text-sm rounded-md hover:bg-accent transition-all-300">
                            <i class="fa fa-plus mr-1"></i>快速添加
                        </button>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">分类名称</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">描述</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">商品数量</th>
                                    <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                </tr>
                            </thead>
                            <tbody id="categories-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- 分类列表将通过 JavaScript 动态生成 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 快速添加分类表单 -->
                    <div id="quick-add-category-form" class="mt-4 bg-gray-50 p-3 rounded-lg hidden">
                        <form>
                            <div class="flex space-x-2">
                                <input type="text" id="quick-category-name" placeholder="分类名称" required class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <input type="text" id="quick-category-description" placeholder="描述（可选）" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <button type="submit" class="px-3 py-2 bg-primary text-white rounded-md hover:bg-accent transition-all-300">
                                    保存
                                </button>
                                <button type="button" id="cancel-quick-add-category" class="px-3 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-100 transition-all-300">
                                    取消
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- 语言设置内容 -->
                <div id="language-tab-content" class="tab-content hidden">
                    <div class="mb-4">
                        <h4 class="text-lg font-medium text-gray-800 mb-3" data-i18n="selectLanguage">选择语言</h4>
                        <div class="space-y-3">
                            <div class="flex items-center">
                                <select id="language-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <option value="zh-CN">简体中文</option>
                                    <option value="zh-TW">繁體中文</option>
                                    <option value="en-US">English</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <p class="text-sm text-blue-700" data-i18n="languageNote">注意：切换语言后，系统将刷新以应用新的语言设置。</p>
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button id="save-language-btn" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-accent transition-all-300" data-i18n="saveSettings">保存设置</button>
                    </div>
                </div>

                <!-- 管理商品内容 -->
                <div id="items-tab-content" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-medium text-gray-800">商品列表</h4>
                        <div class="flex space-x-2">
                            <select id="filter-by-category" class="px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="all">所有分类</option>
                                <!-- 分类选项将通过 JavaScript 动态生成 -->
                            </select>
                            <button id="quick-add-item-btn" class="flex items-center px-3 py-1 bg-primary text-white text-sm rounded-md hover:bg-accent transition-all-300">
                                <i class="fa fa-plus mr-1"></i>快速添加
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">商品名称</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">分类</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">收藏类型</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">号码</th>
                                    <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                </tr>
                            </thead>
                            <tbody id="items-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- 商品列表将通过 JavaScript 动态生成 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 快速添加商品表单 -->
                    <div id="quick-add-item-form" class="mt-4 bg-gray-50 p-3 rounded-lg hidden">
                        <form>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <div>
                                    <label for="quick-item-category" class="block text-gray-700 text-sm font-medium mb-1">所属分类</label>
                                    <select id="quick-item-category" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                        <!-- 分类选项将通过 JavaScript 动态生成 -->
                                    </select>
                                </div>
                                <div>
                                    <label for="quick-item-name" class="block text-gray-700 text-sm font-medium mb-1">商品名称</label>
                                    <input type="text" id="quick-item-name" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                                <div>
                                    <label for="quick-item-type" class="block text-gray-700 text-sm font-medium mb-1">收藏类型</label>
                                    <select id="quick-item-type" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                        <!-- 收藏类型选项将通过 JavaScript 动态生成 -->
                                    </select>
                                </div>
                                <div>
                                    <label for="quick-item-currency" class="block text-gray-700 text-sm font-medium mb-1">币种</label>
                                    <select id="quick-item-currency" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                        <option value="">请选择币种</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="quick-item-denomination" class="block text-gray-700 text-sm font-medium mb-1">面额</label>
                                    <input type="text" id="quick-item-denomination" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                                <div>
                                    <label for="quick-item-serial" class="block text-gray-700 text-sm font-medium mb-1">号码</label>
                                    <input type="text" id="quick-item-serial" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                            </div>
                            <div class="mt-3 flex justify-end space-x-2">
                                <button type="button" id="cancel-quick-add-item" class="px-3 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-100 transition-all-300">
                                    取消
                                </button>
                                <button type="submit" class="px-3 py-2 bg-primary text-white rounded-md hover:bg-accent transition-all-300">
                                    保存
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- 显示方式设置 -->
                <div id="display-tab-content" class="tab-content hidden">
                    <div class="space-y-4">
                        <div class="text-sm text-gray-600">选择显示模式</div>
                        <div class="bg-gray-50 rounded-xl border overflow-hidden">
                            <label class="flex items-center justify-between px-4 py-3 border-b"><span>桌面模式</span><input type="radio" name="display-mode" value="desktop" id="display-desktop"></label>
                            <label class="flex items-center justify-between px-4 py-3"><span>手机模式</span><input type="radio" name="display-mode" value="mobile" id="display-mobile"></label>
                        </div>
                        <div class="text-right"><button id="save-display-settings" class="px-4 py-2 bg-primary text-white rounded-lg">保存</button></div>
                    </div>
                </div>

                <!-- 管理币种 -->
                <div id="currencies-tab-content" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-medium text-gray-800">币种列表</h4>
                        <button id="quick-add-currency-btn" class="flex items-center px-3 py-1 bg-primary text-white text-sm rounded-md hover:bg-accent transition-all-300">
                            <i class="fa fa-plus mr-1"></i>快速添加
                        </button>
                    </div>
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">代碼</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">顯示名（隨語言）</th>
                                    <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                </tr>
                            </thead>
                            <tbody id="currencies-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    <div id="quick-add-currency-form" class="mt-4 bg-gray-50 p-3 rounded-lg hidden">
                        <form>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                <input type="text" id="currency-code-input" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="代碼（如 CNY）" required>
                                <input type="text" id="currency-zhcn-input" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="中文（簡體）名稱">
                                <input type="text" id="currency-zhtw-input" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="中文（繁體）名稱">
                                <input type="text" id="currency-en-input" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="English name">
                            </div>
                            <div class="mt-3 flex justify-between">
                                <button type="button" id="cancel-quick-add-currency" class="px-3 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-100 transition-all-300">取消</button>
                                <button type="submit" class="px-3 py-2 bg-primary text-white rounded-md hover:bg-accent transition-all-300">保存</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- 管理支出分类 -->
                <div id="expense-cats-tab-content" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-medium text-gray-800">支出分类列表</h4>
                        <button id="quick-add-expense-cat-btn" class="flex items-center px-3 py-1 bg-primary text-white text-sm rounded-md hover:bg-accent transition-all-300">
                            <i class="fa fa-plus mr-1"></i>快速添加
                        </button>
                    </div>
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">名称</th>
                                    <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                </tr>
                            </thead>
                            <tbody id="expense-cats-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    <div id="quick-add-expense-cat-form" class="mt-4 bg-gray-50 p-3 rounded-lg hidden">
                        <form>
                            <div class="flex space-x-2">
                                <input type="text" id="quick-expense-cat-name" placeholder="名称" required class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <button type="submit" class="px-3 py-2 bg-primary text-white rounded-md hover:bg-accent transition-all-300">保存</button>
                                <button type="button" id="cancel-quick-expense-cat" class="px-3 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-100 transition-all-300">取消</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- 管理收入分类 -->
                <div id="income-cats-tab-content" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-medium text-gray-800">收入分类列表</h4>
                        <button id="quick-add-income-cat-btn" class="flex items-center px-3 py-1 bg-primary text-white text-sm rounded-md hover:bg-accent transition-all-300">
                            <i class="fa fa-plus mr-1"></i>快速添加
                        </button>
                    </div>
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">名称</th>
                                    <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                </tr>
                            </thead>
                            <tbody id="income-cats-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    <div id="quick-add-income-cat-form" class="mt-4 bg-gray-50 p-3 rounded-lg hidden">
                        <form>
                            <div class="flex space-x-2">
                                <input type="text" id="quick-income-cat-name" placeholder="名称" required class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <button type="submit" class="px-3 py-2 bg-primary text-white rounded-md hover:bg-accent transition-all-300">保存</button>
                                <button type="button" id="cancel-quick-income-cat" class="px-3 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-100 transition-all-300">取消</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- 管理收藏类型内容 -->
                <div id="types-tab-content" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-medium text-gray-800">收藏类型列表</h4>
                        <button id="quick-add-type-btn" class="flex items-center px-3 py-1 bg-primary text-white text-sm rounded-md hover:bg-accent transition-all-300">
                            <i class="fa fa-plus mr-1"></i>快速添加
                        </button>
                    </div>
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">类型名称</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">所属分类</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">商品数量</th>
                                    <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                </tr>
                            </thead>
                            <tbody id="types-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    <div id="quick-add-type-form" class="mt-4 bg-gray-50 p-3 rounded-lg hidden">
                        <form>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <div>
                                    <label for="quick-type-category" class="block text-gray-700 text-sm font-medium mb-1">所属分类</label>
                                    <select id="quick-type-category" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"></select>
                                </div>
                                <div class="md:col-span-2">
                                    <label for="quick-type-name" class="block text-gray-700 text-sm font-medium mb-1">类型名称</label>
                                    <input type="text" id="quick-type-name" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                            </div>
                            <div class="mt-3 flex justify-end space-x-2">
                                <button type="button" id="cancel-quick-add-type" class="px-3 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-100 transition-all-300">取消</button>
                                <button type="submit" class="px-3 py-2 bg-primary text-white rounded-md hover:bg-accent transition-all-300">保存</button>
                            </div>
                        </form>
                    </div>
                </div>
                

            </div>
        </div>
    </div>

    <!-- 记账模态框 -->
    <div id="transaction-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="modal-backdrop absolute inset-0" onclick="closeModal('transaction-modal')"></div>
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md z-10 animate-fadeIn max-h-[80vh] overflow-y-auto">
            <div class="p-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 id="transaction-modal-title" class="text-xl font-bold text-gray-800">记录支出</h3>
                    <button onclick="closeModal('transaction-modal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <form id="transaction-form">
                    <input type="hidden" id="transaction-type" value="expense">
                    <div class="mb-3">
                        <label for="transaction-amount" class="block text-gray-700 font-medium mb-1">金额</label>
                        <input type="number" id="transaction-amount" step="0.01" min="0" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                    <div class="mb-3">
                        <label for="transaction-budget" class="block text-gray-700 font-medium mb-1" data-i18n="budgetType">预算类型</label>
                        <select id="transaction-budget" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="">请选择预算类型</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="transaction-category" class="block text-gray-700 font-medium mb-1">分类</label>
                        <select id="transaction-category" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="">请选择</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="transaction-date" class="block text-gray-700 font-medium mb-1">日期</label>
                        <input type="date" id="transaction-date" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                    <div class="mb-3">
                        <label for="transaction-note" class="block text-gray-700 font-medium mb-1">备注（可选）</label>
                        <textarea id="transaction-note" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeModal('transaction-modal')" class="px-3 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-all-300">
                            取消
                        </button>
                        <button type="submit" class="px-3 py-2 bg-primary text-white rounded-md hover:bg-accent transition-all-300">
                            保存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- 成功提示 -->
    <div id="success-toast" class="fixed bottom-4 right-4 bg-green-500 text-white px-4 py-3 rounded-md shadow-lg transform translate-y-10 opacity-0 transition-all duration-300 z-50">
        <div class="flex items-center">
            <i class="fa fa-check-circle mr-2"></i>
            <span id="toast-message"></span>
        </div>
    </div>

    <script>
        // 语言包
        const translations = {
            'zh-CN': {
                appTitle: '收藏品管理系统',
                addCategory: '添加分类',
                addItem: '添加商品',
                settings: '设置',
                categories: '分类',
                allCollections: '全部藏品',
                searchPlaceholder: '搜索藏品...',
                sortByName: '按名称排序',
                sortByDate: '按创建时间排序',
                noItems: '暂无藏品',
                addItemToCategory: '该分类下还没有藏品，点击"添加商品"按钮添加',
                welcomeTitle: '欢迎使用收藏品管理系统',
                welcomeSubtitle: '开始管理您的收藏品，创建分类并添加商品',
                categoryName: '分类名称',
                categoryDescription: '分类描述（可选）',
                itemName: '商品名称',
                itemCategory: '所属分类',
                itemCurrency: '币种',
                itemDenomination: '面额',
                itemCollectionType: '收藏类型',
                itemSerialNumber: '号码',
                itemNotes: '备注（可选）',
                uploadImage: '上传照片',
                clickOrDrag: '点击或拖拽图片到此处上传',
                save: '保存',
                cancel: '取消',
                itemDetails: '商品详情',
                edit: '编辑',
                delete: '删除',
                confirmDelete: '确认删除',
                confirmDeleteMessage: '您确定要删除这个项目吗？此操作无法撤销。',
                manageCategories: '管理分类',
                manageItems: '管理商品',
                categoryList: '分类列表',
                itemList: '商品列表',
                quickAdd: '快速添加',
                quickAddCategory: '快速添加分类',
                quickAddItem: '快速添加商品',
                description: '描述',
                itemCount: '商品数量',
                actions: '操作',
                name: '名称',
                category: '分类',
                collectionType: '收藏类型',
                serialNumber: '号码',
                createdAt: '创建时间',
                notes: '备注',
                deleteSelected: '删除选中',
                allCategories: '所有分类',
                newType: '添加新类型',
                languageSettings: '语言设置',
                selectLanguage: '选择语言',
                languageNote: '注意：切换语言后，系统将刷新以应用新的语言设置。',
                saveSettings: '保存设置',
                successMessage: '操作成功！',
                errorMessage: '操作失败，请重试。',
                deleteSuccess: '删除成功！',
                editItem: '编辑商品',
                confirmDeleteTitle: '确认删除',
                selectCategory: '请选择分类',
                selectCurrency: '请选择币种',
                selectCollectionType: '请选择或输入收藏类型',
                pleaseSelect: '请选择',
                pleaseSelectCurrency: '请选择币种',
                pleaseInputName: '请输入名称',
                pleaseInputSerialNumber: '请输入号码',
                pleaseInputDenomination: '请输入面额',
                addNewType: '添加新类型',
                filterByCategory: '按分类筛选',
                deleteSelectedItems: '删除选中',
                budgetManagement: '管理预算',
                addBudget: '新增预算',
                budgetName: '预算名称',
                budgetType: '预算类型',
                budgetAmount: '预算金额',
                noBudgets: '暂无预算',
                budgetInUse: '该预算已有关联记录，无法删除',
                selectBudgetType: '请选择预算类型'
            },
            'zh-TW': {
                appTitle: '收藏品管理系統',
                addCategory: '添加分類',
                addItem: '添加商品',
                settings: '設置',
                categories: '分類',
                allCollections: '全部藏品',
                searchPlaceholder: '搜索藏品...',
                sortByName: '按名稱排序',
                sortByDate: '按創建時間排序',
                noItems: '暫無藏品',
                addItemToCategory: '該分類下還沒有藏品，點擊"添加商品"按鈕添加',
                welcomeTitle: '歡迎使用收藏品管理系統',
                welcomeSubtitle: '開始管理您的收藏品，創建分類並添加商品',
                categoryName: '分類名稱',
                categoryDescription: '分類描述（可選）',
                itemName: '商品名稱',
                itemCategory: '所屬分類',
                itemCurrency: '幣種',
                itemDenomination: '面額',
                itemCollectionType: '收藏類型',
                itemSerialNumber: '號碼',
                itemNotes: '備註（可選）',
                uploadImage: '上傳照片',
                clickOrDrag: '點擊或拖拽圖片到此處上傳',
                save: '保存',
                cancel: '取消',
                itemDetails: '商品詳情',
                edit: '編輯',
                delete: '刪除',
                confirmDelete: '確認刪除',
                confirmDeleteMessage: '您確定要刪除此項目嗎？此操作無法撤銷。',
                manageCategories: '管理分類',
                manageItems: '管理商品',
                categoryList: '分類列表',
                itemList: '商品列表',
                quickAdd: '快速添加',
                quickAddCategory: '快速添加分類',
                quickAddItem: '快速添加商品',
                description: '描述',
                itemCount: '商品數量',
                actions: '操作',
                name: '名稱',
                category: '分類',
                collectionType: '收藏類型',
                serialNumber: '號碼',
                createdAt: '創建時間',
                notes: '備註',
                deleteSelected: '刪除選中',
                allCategories: '所有分類',
                newType: '添加新類型',
                languageSettings: '語言設置',
                selectLanguage: '選擇語言',
                languageNote: '注意：切換語言後，系統將刷新以應用新的語言設置。',
                saveSettings: '保存設置',
                successMessage: '操作成功！',
                errorMessage: '操作失敗，請重試。',
                deleteSuccess: '刪除成功！',
                editItem: '編輯商品',
                confirmDeleteTitle: '確認刪除',
                selectCategory: '請選擇分類',
                selectCurrency: '請選擇幣種',
                selectCollectionType: '請選擇或輸入收藏類型',
                pleaseSelect: '請選擇',
                pleaseSelectCurrency: '請選擇幣種',
                pleaseInputName: '請輸入名稱',
                pleaseInputSerialNumber: '請輸入號碼',
                pleaseInputDenomination: '請輸入面額',
                addNewType: '添加新類型',
                filterByCategory: '按分類篩選',
                deleteSelectedItems: '刪除選中',
                budgetManagement: '管理預算',
                addBudget: '新增預算',
                budgetName: '預算名稱',
                budgetType: '預算類型',
                budgetAmount: '預算金額',
                noBudgets: '暫無預算',
                budgetInUse: '該預算已有關聯記錄，無法刪除',
                selectBudgetType: '請選擇預算類型'
            },
            'en-US': {
                appTitle: 'Collection Management System',
                addCategory: 'Add Category',
                addItem: 'Add Item',
                settings: 'Settings',
                categories: 'Categories',
                allCollections: 'All Collections',
                searchPlaceholder: 'Search collections...',
                sortByName: 'Sort by Name',
                sortByDate: 'Sort by Date',
                noItems: 'No Items',
                addItemToCategory: 'No items in this category. Click "Add Item" to add.',
                welcomeTitle: 'Welcome to Collection Management System',
                welcomeSubtitle: 'Start managing your collections by creating categories and adding items',
                categoryName: 'Category Name',
                categoryDescription: 'Category Description (Optional)',
                itemName: 'Item Name',
                itemCategory: 'Category',
                itemCurrency: 'Currency',
                itemDenomination: 'Denomination',
                itemCollectionType: 'Collection Type',
                itemSerialNumber: 'Serial Number',
                itemNotes: 'Notes (Optional)',
                uploadImage: 'Upload Image',
                clickOrDrag: 'Click or drag image to upload',
                save: 'Save',
                cancel: 'Cancel',
                itemDetails: 'Item Details',
                edit: 'Edit',
                delete: 'Delete',
                confirmDelete: 'Confirm Delete',
                confirmDeleteMessage: 'Are you sure you want to delete this item? This action cannot be undone.',
                manageCategories: 'Manage Categories',
                manageItems: 'Manage Items',
                categoryList: 'Category List',
                itemList: 'Item List',
                quickAdd: 'Quick Add',
                quickAddCategory: 'Quick Add Category',
                quickAddItem: 'Quick Add Item',
                description: 'Description',
                itemCount: 'Item Count',
                actions: 'Actions',
                name: 'Name',
                category: 'Category',
                collectionType: 'Collection Type',
                serialNumber: 'Serial Number',
                createdAt: 'Created At',
                notes: 'Notes',
                deleteSelected: 'Delete Selected',
                allCategories: 'All Categories',
                newType: 'Add New Type',
                languageSettings: 'Language Settings',
                selectLanguage: 'Select Language',
                languageNote: 'Note: After changing language, the system will refresh to apply new language settings.',
                saveSettings: 'Save Settings',
                successMessage: 'Operation successful!',
                errorMessage: 'Operation failed, please try again.',
                deleteSuccess: 'Deletion successful!',
                editItem: 'Edit Item',
                confirmDeleteTitle: 'Confirm Deletion',
                selectCategory: 'Please select category',
                selectCurrency: 'Please select currency',
                selectCollectionType: 'Please select or enter collection type',
                pleaseSelect: 'Please select',
                pleaseSelectCurrency: 'Please select currency',
                pleaseInputName: 'Please enter name',
                pleaseInputSerialNumber: 'Please enter serial number',
                pleaseInputDenomination: 'Please enter denomination',
                addNewType: 'Add new type',
                filterByCategory: 'Filter by Category',
                deleteSelectedItems: 'Delete Selected Items',
                budgetManagement: 'Manage Budget',
                addBudget: 'Add Budget',
                budgetName: 'Budget Name',
                budgetType: 'Budget Type',
                budgetAmount: 'Budget Amount',
                noBudgets: 'No Budgets',
                budgetInUse: 'This budget is linked to records and cannot be deleted',
                selectBudgetType: 'Please select budget type'
            }
        };
        
        // 数据存储
        let categories = JSON.parse(localStorage.getItem('collection_categories')) || [];
        let collectionTypes = JSON.parse(localStorage.getItem('collection_types')) || [];
        let budgets = JSON.parse(localStorage.getItem('collection_budgets')) || [];
        let expenseCategories = JSON.parse(localStorage.getItem('expense_categories')) || [];
        let incomeCategories = JSON.parse(localStorage.getItem('income_categories')) || [];
        (function(){
            const removedFlag = localStorage.getItem('preset_types_removed');
            const before = collectionTypes.length;
            collectionTypes = collectionTypes.filter(t => !(['type-1','type-2','type-3','type-4','type-5','type-6','type-7','type-8'].includes(t.id)));
            if (!removedFlag && collectionTypes.length !== before) {
                localStorage.setItem('collection_types', JSON.stringify(collectionTypes));
                localStorage.setItem('preset_types_removed', '1');
            }
        })();
        let collectionItems = JSON.parse(localStorage.getItem('collection_items')) || [];
        budgets = budgets.map(b => {
            const ia = b.initialAmount !== undefined ? parseFloat(b.initialAmount) : parseFloat(b.amount || 0);
            return { ...b, initialAmount: ia };
        });
        
        // 当前选中的分类ID
        let currentCategoryId = 'all';
        
        // 当前查看的商品ID
        let currentItemId = null;
        
        // 当前语言
        let currentLanguage = localStorage.getItem('collection_language') || 'zh-CN';

        // 应用翻译
        function applyTranslations() {
            try {
                const lang = currentLanguage;
                document.querySelectorAll('[data-i18n]').forEach(element => {
                    const key = element.getAttribute('data-i18n');
                    if (translations[lang] && translations[lang][key]) {
                        element.textContent = translations[lang][key];
                    }
                });
                
                // 更新页面标题
                if (translations[lang] && translations[lang].appTitle) {
                    document.title = translations[lang].appTitle;
                }
                
                // 更新占位符文本
                const searchInput = document.getElementById('search-input');
                if (searchInput && translations[lang] && translations[lang].searchPlaceholder) {
                    searchInput.placeholder = translations[lang].searchPlaceholder;
                }
                
                // 更新下拉框选项
                try {
                    const nameOption = document.querySelector('#sort-select option[value="name"]');
                    const dateOption = document.querySelector('#sort-select option[value="createdAt"]');
                    if (nameOption && translations[lang] && translations[lang].sortByName) {
                        nameOption.textContent = translations[lang].sortByName;
                    }
                    if (dateOption && translations[lang] && translations[lang].sortByDate) {
                        dateOption.textContent = translations[lang].sortByDate;
                    }
                } catch (e) {
                    console.warn('Error updating sort options:', e);
                }
                
                
            } catch (e) {
                console.error('Error in applyTranslations:', e);
            }
        }
        
        // 初始化语言设置
        function initLanguageSettings() {
            try {
                // 设置当前选中的语言单选按钮
                const langRadio = document.getElementById(`lang-${currentLanguage}`);
                if (langRadio) {
                    langRadio.checked = true;
                }
                
                // 绑定语言选择事件
                const languageRadios = document.querySelectorAll('input[name="language"]');
                languageRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        currentLanguage = this.value;
                        renderCurrencyOptions();
                        renderCurrenciesTable();
                    });
                });
                
                // 绑定语言选择下拉菜单事件
                const languageSelect = document.getElementById('language-select');
                if (languageSelect) {
                    // 设置当前选中的语言
                    languageSelect.value = currentLanguage;
                    
                    languageSelect.addEventListener('change', function() {
                        currentLanguage = this.value;
                        applyTranslations();
                        renderCurrencyOptions();
                        renderCurrenciesTable();
                    });
                }
                
                // 绑定保存语言设置按钮事件
                const saveLanguageBtn = document.getElementById('save-language-btn');
                if (saveLanguageBtn) {
                    saveLanguageBtn.addEventListener('click', function() {
                        localStorage.setItem('collection_language', currentLanguage);
                        if (translations[currentLanguage] && translations[currentLanguage].successMessage) {
                            showToast(translations[currentLanguage].successMessage, 'success');
                        } else {
                            showToast('操作成功！', 'success');
                        }
                        // 刷新页面以应用新的语言设置
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    });
                }
            } catch (e) {
                console.error('Error in initLanguageSettings:', e);
            }
        }

        // 记账数据结构
        let transactions = JSON.parse(localStorage.getItem('collection_transactions')) || [];
        
        // DOM 加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化语言设置
            try {
                initLanguageSettings();
                applyTranslations();
                
                // 确保语言单选按钮状态正确
                const languageRadios = document.querySelectorAll('input[name="language"]');
                languageRadios.forEach(radio => {
                    if (radio.value === currentLanguage) {
                        radio.checked = true;
                    }
                });
            } catch (e) {
                console.error('Error initializing language settings:', e);
            }
            
            // 绑定记账功能按钮事件
            document.getElementById('expense-list-btn').addEventListener('click', function() {
                showTransactionsListView('expense');
            });
            
            document.getElementById('income-list-btn').addEventListener('click', function() {
                showTransactionsListView('income');
            });
            
            document.getElementById('statistics-btn').addEventListener('click', function() {
                showStatisticsView();
            });

            document.getElementById('budget-manage-btn').addEventListener('click', function() {
                showBudgetManageView();
            });

            document.getElementById('quick-add-budget-btn').addEventListener('click', function() {
                document.getElementById('quick-add-budget-form').classList.toggle('hidden');
            });

            document.getElementById('cancel-quick-add-budget').addEventListener('click', function() {
                document.getElementById('quick-add-budget-form').classList.add('hidden');
                document.getElementById('quick-add-budget-form').querySelector('form').reset();
            });

            document.getElementById('quick-add-budget-form').querySelector('form').addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('budget-name').value.trim();
                const type = document.getElementById('budget-type').value.trim();
                const amountStr = document.getElementById('budget-amount').value;
                const amount = parseFloat(amountStr);
                if (!name || !type || isNaN(amount)) {
                    showToast('请填写所有必填字段', 'error');
                    return;
                }
                if (budgets.some(b => b.type === type)) {
                    showToast('预算类型已存在', 'error');
                    return;
                }
                const newBudget = { id: 'budget-' + Date.now(), name, type, amount: amount.toFixed(2), initialAmount: amount.toFixed(2), createdAt: new Date().toISOString() };
                budgets.push(newBudget);
                saveBudgets();
                renderBudgetsTable();
                this.reset();
                document.getElementById('quick-add-budget-form').classList.add('hidden');
                showToast('预算添加成功');
            });
            
            // 初始化数据
            if (categories.length === 0) {
                // 添加默认分类
                categories = [
                    { id: 'default-1', name: translations[currentLanguage].itemCategory === '所属分类' ? '邮票' : translations[currentLanguage].itemCategory === '所屬分類' ? '郵票' : 'Stamps', description: translations[currentLanguage].itemCategory === '所属分类' ? '各类邮票收藏' : translations[currentLanguage].itemCategory === '所屬分類' ? '各類郵票收藏' : 'Various stamp collections', createdAt: new Date().toISOString() },
                    { id: 'default-2', name: translations[currentLanguage].itemCategory === '所属分类' ? '钱币' : translations[currentLanguage].itemCategory === '所屬分類' ? '錢幣' : 'Coins', description: translations[currentLanguage].itemCategory === '所属分类' ? '各国钱币收藏' : translations[currentLanguage].itemCategory === '所屬分類' ? '各國錢幣收藏' : 'World coin collections', createdAt: new Date().toISOString() },
                    { id: 'default-3', name: translations[currentLanguage].itemCategory === '所属分类' ? '徽章' : translations[currentLanguage].itemCategory === '所屬分類' ? '徽章' : 'Badges', description: translations[currentLanguage].itemCategory === '所属分类' ? '各类徽章收藏' : translations[currentLanguage].itemCategory === '所屬分類' ? '各類徽章收藏' : 'Various badge collections', createdAt: new Date().toISOString() }
                ];
                saveCategories();
            }
            
            if (collectionTypes.length === 0) {
                collectionTypes = [];
                saveCollectionTypes();
            }
            
            // 渲染界面
            renderCategories();
            renderCategoryOptions();
            renderCollectionTypeOptions();
            updateTotalCount();
            
            // 如果没有分类和商品，显示欢迎页面
            if (categories.length === 0 && collectionItems.length === 0) {
                document.getElementById('welcome-screen').classList.remove('hidden');
                document.getElementById('category-content').classList.add('hidden');
            } else {
                document.getElementById('welcome-screen').classList.add('hidden');
                document.getElementById('category-content').classList.remove('hidden');
                renderItems();
            }
            
            // 绑定事件
            try {
                bindEvents();
            } catch (e) {
                console.error('Error in bindEvents:', e);
            }

            try {
                initAuth();
                loadCurrencies();
                renderCurrencyOptions();
                applyDisplayMode();
                initSwipeGestures();
                initDisplaySettings();
            } catch (e) {
                console.error('Error initializing features:', e);
            }
        });

        // 绑定事件
        function bindEvents() {
            // 添加分类按钮
            document.getElementById('add-category-btn').addEventListener('click', function() {
                openModal('add-category-modal');
            });
            
            document.getElementById('welcome-add-category-btn').addEventListener('click', function() {
                openModal('add-category-modal');
            });
            
            // 添加商品按钮
            document.getElementById('add-item-btn').addEventListener('click', function() {
                openModal('add-item-modal');
            });
            
            document.getElementById('welcome-add-item-btn').addEventListener('click', function() {
                openModal('add-item-modal');
            });
            
            document.getElementById('empty-add-item-btn').addEventListener('click', function() {
                openModal('add-item-modal');
            });
            
            // 添加分类表单提交
            document.getElementById('add-category-form').addEventListener('submit', function(e) {
                e.preventDefault();
                addCategory();
            });
            
            // 添加商品表单提交
            document.getElementById('add-item-form').addEventListener('submit', function(e) {
                e.preventDefault();
                addItem();
            });
            
            // 编辑商品表单提交
            document.getElementById('edit-item-form').addEventListener('submit', function(e) {
                e.preventDefault();
                updateItem();
            });
            
            // 搜索框事件
            document.getElementById('search-input').addEventListener('input', function() {
                renderItems();
            });
            
            // 排序下拉框事件
            document.getElementById('sort-select').addEventListener('change', function() {
                renderItems();
            });
            
            
            
            // 图片上传预览
            const imagePreview = document.getElementById('image-preview');
            const itemImage = document.getElementById('item-image');
            
            imagePreview.addEventListener('click', function() {
                itemImage.click();
            });
            
            imagePreview.addEventListener('dragover', function(e) {
                e.preventDefault();
                imagePreview.classList.add('border-primary');
            });
            
            imagePreview.addEventListener('dragleave', function() {
                imagePreview.classList.remove('border-primary');
            });
            
            imagePreview.addEventListener('drop', function(e) {
                e.preventDefault();
                imagePreview.classList.remove('border-primary');
                
                if (e.dataTransfer.files && e.dataTransfer.files.length) {
                    handleImagesUpload('add', Array.from(e.dataTransfer.files));
                }
            });
            
            itemImage.addEventListener('change', function() {
                if (this.files && this.files.length) {
                    handleImagesUpload('add', Array.from(this.files));
                }
            });
            
            // 编辑商品图片上传预览
            const editImagePreview = document.getElementById('edit-image-preview');
            const editItemImage = document.getElementById('edit-item-image');
            
            editImagePreview.addEventListener('click', function() {
                editItemImage.click();
            });
            
            editImagePreview.addEventListener('dragover', function(e) {
                e.preventDefault();
                editImagePreview.classList.add('border-primary');
            });
            
            editImagePreview.addEventListener('dragleave', function() {
                editImagePreview.classList.remove('border-primary');
            });
            
            editImagePreview.addEventListener('drop', function(e) {
                e.preventDefault();
                editImagePreview.classList.remove('border-primary');
                
                if (e.dataTransfer.files && e.dataTransfer.files.length) {
                    handleImagesUpload('edit', Array.from(e.dataTransfer.files));
                }
            });
            
            editItemImage.addEventListener('change', function() {
                if (this.files && this.files.length) {
                    handleImagesUpload('edit', Array.from(this.files));
                }
            });
            
            // 编辑商品按钮
            document.getElementById('edit-item-btn').addEventListener('click', function() {
                closeModal('item-detail-modal');
                openEditItemModal(currentItemId);
            });
            
            // 删除商品按钮
            document.getElementById('delete-item-btn').addEventListener('click', function() {
                closeModal('item-detail-modal');
                openConfirmDeleteModal(currentItemId);
            });
            
            // 确认删除按钮
            document.getElementById('confirm-delete-btn').addEventListener('click', function() {
                deleteItem(currentItemId);
            });
            
            // 设置按钮
            document.getElementById('settings-btn').addEventListener('click', function() {
                openModal('settings-modal');
                renderCategoriesTable();
                renderItemsTable();
                renderCategoryFilterOptions();
                renderQuickAddCategoryOptions();
                renderQuickAddItemOptions();
                renderTypesTable();
                renderQuickAddTypeOptions();
                renderExpenseCategoriesTable();
                renderIncomeCategoriesTable();
                renderCurrenciesTable();
                initDisplaySettings();
            });
            
            // 设置选项卡切换
            document.querySelectorAll('#settings-tabs button').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // 更新选项卡样式
                    document.querySelectorAll('#settings-tabs button').forEach(t => {
                        t.classList.remove('border-primary', 'text-primary');
                        t.classList.add('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
                    });
                    this.classList.remove('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
                    this.classList.add('border-primary', 'text-primary');
                    
                    // 显示对应内容
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.add('hidden');
                    });
                    document.getElementById(`${tabId}-tab-content`).classList.remove('hidden');
                });
            });
            
            // 快速添加分类按钮
            document.getElementById('quick-add-category-btn').addEventListener('click', function() {
                document.getElementById('quick-add-category-form').classList.toggle('hidden');
            });
            
            // 取消快速添加分类
            document.getElementById('cancel-quick-add-category').addEventListener('click', function() {
                document.getElementById('quick-add-category-form').classList.add('hidden');
                document.getElementById('quick-add-category-form').querySelector('form').reset();
            });
            
            // 快速添加分类表单提交
            document.getElementById('quick-add-category-form').querySelector('form').addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('quick-category-name').value.trim();
                const description = document.getElementById('quick-category-description').value.trim();
                
                if (!name) {
                    showToast('请输入分类名称', 'error');
                    return;
                }
                
                // 检查分类名称是否已存在
                if (categories.some(category => category.name === name)) {
                    showToast('分类名称已存在', 'error');
                    return;
                }
                
                const newCategory = {
                    id: 'category-' + Date.now(),
                    name: name,
                    description: description,
                    createdAt: new Date().toISOString()
                };
                
                categories.push(newCategory);
                saveCategories();
                
                // 更新分类表格和下拉选项
                renderCategoriesTable();
                renderCategories();
                renderCategoryFilterOptions();
                renderQuickAddCategoryOptions();
                renderQuickAddItemOptions();
                renderQuickAddTypeOptions();
                
                // 重置表单并隐藏
                this.reset();
                document.getElementById('quick-add-category-form').classList.add('hidden');
                
                // 显示成功提示
                showToast('分类添加成功');
            });
            
            // 快速添加商品按钮
            document.getElementById('quick-add-item-btn').addEventListener('click', function() {
                document.getElementById('quick-add-item-form').classList.toggle('hidden');
            });
            
            // 取消快速添加商品
            document.getElementById('cancel-quick-add-item').addEventListener('click', function() {
                document.getElementById('quick-add-item-form').classList.add('hidden');
                document.getElementById('quick-add-item-form').querySelector('form').reset();
            });
            
            // 快速添加商品表单提交
            document.getElementById('quick-add-item-form').querySelector('form').addEventListener('submit', function(e) {
                e.preventDefault();
                const categoryId = document.getElementById('quick-item-category').value;
                const name = document.getElementById('quick-item-name').value.trim();
                const collectionTypeId = document.getElementById('quick-item-type').value;
                const currency = document.getElementById('quick-item-currency').value;
                const denomination = document.getElementById('quick-item-denomination').value.trim();
                const serialNumber = document.getElementById('quick-item-serial').value.trim();
                
                // 验证必填字段
                if (!categoryId || !name || !collectionTypeId || !currency || !denomination || !serialNumber) {
                    showToast('请填写所有必填字段', 'error');
                    return;
                }
                
                // 创建新商品
                const newItem = {
                    id: 'item-' + Date.now(),
                    categoryId: categoryId,
                    name: name,
                    currency: currency,
                    denomination: denomination,
                    collectionTypeId: collectionTypeId,
                    serialNumber: serialNumber,
                    imageUrl: null,
                    notes: '',
                    createdAt: new Date().toISOString()
                };
                
                collectionItems.push(newItem);
                saveCollectionItems();
                
                // 更新商品表格和列表
                renderItemsTable();
                renderItems();
                renderCategories();
                updateTotalCount();
                
                // 重置表单并隐藏
                this.reset();
                document.getElementById('quick-add-item-form').classList.add('hidden');
                
                // 显示成功提示
                showToast('商品添加成功');
            });
            
            // 快速添加收藏类型按钮
            document.getElementById('quick-add-type-btn').addEventListener('click', function() {
                document.getElementById('quick-add-type-form').classList.toggle('hidden');
                renderQuickAddTypeOptions();
            });
            
            // 取消快速添加收藏类型
            document.getElementById('cancel-quick-add-type').addEventListener('click', function() {
                document.getElementById('quick-add-type-form').classList.add('hidden');
                document.getElementById('quick-add-type-form').querySelector('form').reset();
            });
            
            // 快速添加收藏类型表单提交
            document.getElementById('quick-add-type-form').querySelector('form').addEventListener('submit', function(e) {
                e.preventDefault();
                const categoryId = document.getElementById('quick-type-category').value;
                const typeName = document.getElementById('quick-type-name').value.trim();
                
                if (!categoryId || !typeName) {
                    showToast('请填写所有必填字段', 'error');
                    return;
                }
                
                if (collectionTypes.some(t => t.categoryId === categoryId && t.name === typeName)) {
                    showToast('该分类下类型名称已存在', 'error');
                    return;
                }
                
                const newType = {
                    id: 'type-' + Date.now(),
                    name: typeName,
                    categoryId: categoryId
                };
                collectionTypes.push(newType);
                saveCollectionTypes();
                renderTypesTable();
                renderCollectionTypeOptions();
                renderQuickAddItemOptions();
                this.reset();
                document.getElementById('quick-add-type-form').classList.add('hidden');
                showToast('收藏类型添加成功');
            });
            
            document.getElementById('quick-add-expense-cat-btn').addEventListener('click', function(){
                document.getElementById('quick-add-expense-cat-form').classList.toggle('hidden');
            });
            document.getElementById('cancel-quick-expense-cat').addEventListener('click', function(){
                document.getElementById('quick-add-expense-cat-form').classList.add('hidden');
                document.getElementById('quick-add-expense-cat-form').querySelector('form').reset();
            });
            document.getElementById('quick-add-expense-cat-form').querySelector('form').addEventListener('submit', function(e){
                e.preventDefault();
                const name = document.getElementById('quick-expense-cat-name').value.trim();
                if (!name) { showToast('请输入名称', 'error'); return; }
                if (expenseCategories.some(c => c.name === name)) { showToast('分类已存在', 'error'); return; }
                expenseCategories.push({ id: 'expense-cat-' + Date.now(), name });
                saveExpenseCategories();
                renderExpenseCategoriesTable();
                this.reset();
                document.getElementById('quick-add-expense-cat-form').classList.add('hidden');
                showToast('添加成功');
            });

            document.getElementById('quick-add-income-cat-btn').addEventListener('click', function(){
                document.getElementById('quick-add-income-cat-form').classList.toggle('hidden');
            });
            document.getElementById('cancel-quick-income-cat').addEventListener('click', function(){
                document.getElementById('quick-add-income-cat-form').classList.add('hidden');
                document.getElementById('quick-add-income-cat-form').querySelector('form').reset();
            });
            document.getElementById('quick-add-income-cat-form').querySelector('form').addEventListener('submit', function(e){
                e.preventDefault();
                const name = document.getElementById('quick-income-cat-name').value.trim();
                if (!name) { showToast('请输入名称', 'error'); return; }
                if (incomeCategories.some(c => c.name === name)) { showToast('分类已存在', 'error'); return; }
                incomeCategories.push({ id: 'income-cat-' + Date.now(), name });
                saveIncomeCategories();
                renderIncomeCategoriesTable();
                this.reset();
                document.getElementById('quick-add-income-cat-form').classList.add('hidden');
                showToast('添加成功');
            });

            // 分类筛选下拉框
            document.getElementById('filter-by-category').addEventListener('change', function() {
                renderItemsTable();
            });
            
            // 监听快速添加商品的分类选择变化，更新收藏类型选项
            document.getElementById('quick-item-category').addEventListener('change', function() {
                renderQuickAddItemTypeOptions(this.value);
            });
        }

        // 渲染分类列表
        function renderCategories() {
            const categoriesList = document.getElementById('categories-list');
            categoriesList.innerHTML = '';
            
            categories.forEach(category => {
                const categoryCount = collectionItems.filter(item => item.categoryId === category.id).length;
                
                const categoryItem = document.createElement('button');
                categoryItem.className = `w-full text-left px-3 py-2 rounded-md flex justify-between items-center ${currentCategoryId === category.id ? 'bg-blue-50 text-primary font-medium' : 'text-gray-700 hover:bg-gray-100'}`;
                categoryItem.innerHTML = `
                    <span>${category.name}</span>
                    <span class="bg-gray-200 text-gray-700 text-xs px-2 py-1 rounded-full">${categoryCount}</span>
                `;
                categoryItem.addEventListener('click', function() {
                    currentCategoryId = category.id;
                    renderCategories();
                    renderItems();
                    
                    // 更新当前分类名称
                    document.getElementById('current-category-name').textContent = category.name;
                    
                    document.getElementById('welcome-screen').classList.add('hidden');
                    document.getElementById('category-content').classList.remove('hidden');
                    const rightPanel = document.getElementById('right-panel');
                    rightPanel.classList.add('hidden');
                    rightPanel.classList.remove('lg:col-span-3');
                    document.getElementById('transactions-list-view').classList.add('hidden');
                    document.getElementById('statistics-view').classList.add('hidden');
                    document.getElementById('budget-view').classList.add('hidden');
                });
                
                categoriesList.appendChild(categoryItem);
            });
        }

        // 渲染分类选项
        function renderCategoryOptions() {
            const itemCategory = document.getElementById('item-category');
            const editItemCategory = document.getElementById('edit-item-category');
            
            itemCategory.innerHTML = '';
            editItemCategory.innerHTML = '';
            
            categories.forEach(category => {
                const option1 = document.createElement('option');
                option1.value = category.id;
                option1.textContent = category.name;
                
                const option2 = document.createElement('option');
                option2.value = category.id;
                option2.textContent = category.name;
                
                itemCategory.appendChild(option1);
                editItemCategory.appendChild(option2);
            });
        }

        // 渲染收藏类型选项
        function renderCollectionTypeOptions() {
            const dl1 = document.getElementById('collection-type-list');
            const dl2 = document.getElementById('edit-collection-type-list');
            if (!dl1 || !dl2) return;
            dl1.innerHTML = '';
            dl2.innerHTML = '';
            const addCatId = document.getElementById('item-category') ? document.getElementById('item-category').value : '';
            const editCatId = document.getElementById('edit-item-category') ? document.getElementById('edit-item-category').value : '';
            const addTypes = collectionTypes.filter(t => t.categoryId === addCatId);
            const editTypes = collectionTypes.filter(t => t.categoryId === editCatId);
            addTypes.forEach(type => { const o = document.createElement('option'); o.value = type.name; dl1.appendChild(o); });
            editTypes.forEach(type => { const o = document.createElement('option'); o.value = type.name; dl2.appendChild(o); });
        }

        // 显示收藏类型建议
        function showTypeSuggestions(inputId, suggestionsId) {
            const input = document.getElementById(inputId);
            const suggestions = document.getElementById(suggestionsId);
            const value = input.value.toLowerCase();
            
            if (value.length < 1) {
                suggestions.classList.add('hidden');
                return;
            }
            
            // 获取当前选中的分类ID
            const categorySelectId = inputId === 'item-collection-type' ? 'item-category' : 'edit-item-category';
            const selectedCategoryId = document.getElementById(categorySelectId).value;
            
            // 筛选出匹配的收藏类型
            const filteredTypes = collectionTypes.filter(type => 
                type.name.toLowerCase().includes(value) && type.categoryId === selectedCategoryId
            );
            
            if (filteredTypes.length === 0) {
                suggestions.classList.add('hidden');
                return;
            }
            
            // 渲染建议列表
            suggestions.innerHTML = '';
            filteredTypes.forEach(type => {
                const suggestionItem = document.createElement('div');
                suggestionItem.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer';
                suggestionItem.textContent = type.name;
                suggestionItem.addEventListener('click', function() {
                    input.value = type.name;
                    suggestions.classList.add('hidden');
                });
                suggestions.appendChild(suggestionItem);
            });
            
            suggestions.classList.remove('hidden');
        }

        // 渲染商品列表
        function renderItems() {
            const itemsGrid = document.getElementById('items-grid');
            const emptyState = document.getElementById('empty-state');
            const searchInput = document.getElementById('search-input').value.toLowerCase();
            const sortSelect = document.getElementById('sort-select').value;
            
            // 筛选商品
            let filteredItems = collectionItems;
            
            if (currentCategoryId !== 'all') {
                filteredItems = filteredItems.filter(item => item.categoryId === currentCategoryId);
            }
            
            if (searchInput) {
                filteredItems = filteredItems.filter(item => 
                    item.name.toLowerCase().includes(searchInput) || 
                    item.serialNumber.toLowerCase().includes(searchInput) ||
                    getCollectionTypeName(item.collectionTypeId).toLowerCase().includes(searchInput)
                );
            }
            
            // 排序商品
            filteredItems.sort((a, b) => {
                if (sortSelect === 'name') {
                    return a.name.localeCompare(b.name);
                } else if (sortSelect === 'createdAt') {
                    return new Date(b.createdAt) - new Date(a.createdAt);
                }
                return 0;
            });
            
            const currentCategory = getCategory(currentCategoryId);
            const centerNames = ['邮票','錢幣','钱币','徽章','Stamps','Coins','Badges'];
            const centeredLayout = currentCategory && centerNames.includes(currentCategory.name);
            if (centeredLayout) {
                itemsGrid.className = 'grid grid-cols-1 gap-6 justify-items-center';
            } else {
                itemsGrid.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6';
            }
            
            // 渲染商品网格
            itemsGrid.innerHTML = '';
            
            if (filteredItems.length === 0) {
                itemsGrid.classList.add('hidden');
                emptyState.classList.remove('hidden');
            } else {
                itemsGrid.classList.remove('hidden');
                emptyState.classList.add('hidden');
                
                filteredItems.forEach(item => {
                    const category = getCategory(item.categoryId);
                    const collectionType = getCollectionType(item.collectionTypeId);
                    
                    const itemCard = document.createElement('div');
                    itemCard.className = 'collection-card bg-white rounded-lg shadow-card overflow-hidden';
                    if (centeredLayout) {
                        itemCard.classList.add('w-full','max-w-md');
                        itemsGrid.style.maxHeight = '60vh';
                        itemsGrid.style.overflowY = 'auto';
                    } else {
                        itemsGrid.style.maxHeight = '';
                        itemsGrid.style.overflowY = '';
                    }
                    const primaryImg = getPrimaryImage(item);
                    itemCard.innerHTML = `
                        <div class="h-48 bg-gray-100 flex items-center justify-center">
                            ${primaryImg ? 
                                `<img src="${primaryImg}" alt="${item.name}" class="max-w-full max-h-full object-contain">` : 
                                `<i class="fa fa-image text-gray-400 text-4xl"></i>`
                            }
                        </div>
                        <div class="p-4">
                            <h3 class="font-semibold text-gray-800 truncate">${item.name}</h3>
                            <p class="text-sm text-gray-500 mb-2">${category ? category.name : '未分类'}</p>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">${collectionType ? collectionType.name : '未分类'}</span>
                                <span class="text-sm font-medium text-primary">${item.serialNumber}</span>
                            </div>
                        </div>
                    `;
                    itemCard.addEventListener('click', function() {
                        openItemDetailModal(item.id);
                    });
                    
                    itemsGrid.appendChild(itemCard);
                });
            }
        }

        // 添加分类
        function addCategory() {
            const name = document.getElementById('category-name').value.trim();
            const description = document.getElementById('category-description').value.trim();
            
            if (!name) {
                showToast('请输入分类名称', 'error');
                return;
            }
            
            // 检查分类名称是否已存在
            if (categories.some(category => category.name === name)) {
                showToast('分类名称已存在', 'error');
                return;
            }
            
            const newCategory = {
                id: 'category-' + Date.now(),
                name: name,
                description: description,
                createdAt: new Date().toISOString()
            };
            
            categories.push(newCategory);
            saveCategories();
            
            // 更新分类列表和选项
            renderCategories();
            renderCategoryOptions();
            
            // 关闭模态框
            closeModal('add-category-modal');
            
            // 重置表单
            document.getElementById('add-category-form').reset();
            
            // 显示成功提示
            showToast('分类添加成功');
            
            // 切换到新添加的分类
            currentCategoryId = newCategory.id;
            renderCategories();
            renderItems();
            
            // 更新当前分类名称
            document.getElementById('current-category-name').textContent = newCategory.name;
            
            // 显示分类内容页面
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('category-content').classList.remove('hidden');
        }

        // 添加商品
        function addItem() {
            const categoryId = document.getElementById('item-category').value;
            const name = document.getElementById('item-name').value.trim();
            const currency = document.getElementById('item-currency').value;
            const denomination = document.getElementById('item-denomination').value.trim();
            const collectionTypeInput = document.getElementById('item-collection-type').value.trim();
            const serialNumber = document.getElementById('item-serial-number').value.trim();
            const codeInput = document.getElementById('item-code').value.trim();
            const autoCode = document.getElementById('auto-code').checked;
            const notes = document.getElementById('item-notes').value.trim();
            
            // 验证必填字段
            if (!categoryId || !name || !currency || !denomination || !collectionTypeInput || !serialNumber) {
                showToast('请填写所有必填字段', 'error');
                return;
            }
            
            let collectionTypeId;
            const existingType = collectionTypes.find(type => type.name === collectionTypeInput && type.categoryId === categoryId);
            if (existingType) {
                collectionTypeId = existingType.id;
            } else {
                const newCollectionType = { id: 'type-' + Date.now(), name: collectionTypeInput, categoryId: categoryId };
                collectionTypes.push(newCollectionType);
                saveCollectionTypes();
                collectionTypeId = newCollectionType.id;
            }
            
            // 获取图片URL
            const previewImage = document.getElementById('preview-image');
            const imageUrl = previewImage.classList.contains('hidden') ? null : previewImage.src;
            
            // 创建新商品
            const code = autoCode || !codeInput ? getNextItemCode() : codeInput;
            const newItem = {
                id: 'item-' + Date.now(),
                categoryId: categoryId,
                name: name,
                currency: currency,
                denomination: denomination,
                collectionTypeId: collectionTypeId,
                serialNumber: serialNumber,
                code: code,
                imageUrl: imageUrl,
                imageUrls: addItemImages && addItemImages.length ? [...addItemImages] : (imageUrl ? [imageUrl] : []),
                notes: notes,
                createdAt: new Date().toISOString()
            };
            
            collectionItems.push(newItem);
            saveCollectionItems();
            
            // 更新商品列表
            renderItems();
            renderCategories();
            updateTotalCount();

            // 关闭模态框
            closeModal('add-item-modal');

            // 重置表单
            document.getElementById('add-item-form').reset();
            resetImagePreview();
            addItemImages = [];
            renderThumbs('add');

            // 更新下一个编号
            incrementNextItemCode(code);
            
            // 显示成功提示
            showToast('商品添加成功');
        }

        // 打开商品详情模态框
        function openItemDetailModal(itemId) {
            const item = collectionItems.find(item => item.id === itemId);
            
            if (!item) return;
            
            currentItemId = itemId;
            
            // 填充商品详情
            document.getElementById('detail-name').textContent = item.name;
            document.getElementById('detail-category').textContent = getCategory(item.categoryId).name;
            document.getElementById('detail-currency').textContent = item.currency;
            document.getElementById('detail-collection-type').textContent = getCollectionTypeName(item.collectionTypeId);
            document.getElementById('detail-denomination').textContent = item.denomination;
            document.getElementById('detail-serial-number').textContent = item.serialNumber;
            document.getElementById('detail-notes').textContent = item.notes || '无';
            document.getElementById('detail-created-at').textContent = formatDate(item.createdAt);
            
            // 设置图片
            const detailImage = document.getElementById('detail-image');
            const primaryImg = getPrimaryImage(item);
            if (primaryImg) {
                detailImage.src = primaryImg;
                detailImage.classList.remove('hidden');
            } else {
                detailImage.src = '';
                detailImage.classList.add('hidden');
            }
            
            // 打开模态框
            openModal('item-detail-modal');
        }

        // 打开编辑商品模态框
        function openEditItemModal(itemId) {
            const item = collectionItems.find(item => item.id === itemId);
            
            if (!item) return;
            
            // 填充表单
            document.getElementById('edit-item-id').value = item.id;
            document.getElementById('edit-item-category').value = item.categoryId;
            document.getElementById('edit-item-name').value = item.name;
            document.getElementById('edit-item-currency').value = item.currency;
            document.getElementById('edit-item-denomination').value = item.denomination;
            document.getElementById('edit-item-collection-type').value = getCollectionTypeName(item.collectionTypeId);
            document.getElementById('edit-item-serial-number').value = item.serialNumber;
            document.getElementById('edit-item-notes').value = item.notes || '';
            
            // 设置图片
            const editPreviewPlaceholder = document.getElementById('edit-preview-placeholder');
            const editPreviewImage = document.getElementById('edit-preview-image');
            const editImagePreview = document.getElementById('edit-image-preview');
            const removeImageBtn = editImagePreview.querySelector('.remove-image');
            
            editItemImages = Array.isArray(item.imageUrls) ? [...item.imageUrls] : (item.imageUrl ? [item.imageUrl] : []);
            if (editItemImages.length > 0) {
                editPreviewPlaceholder.classList.add('hidden');
                editPreviewImage.src = editItemImages[0];
                editPreviewImage.classList.remove('hidden');
                editImagePreview.classList.add('has-image');
                removeImageBtn.classList.remove('hidden');
            } else {
                resetEditImagePreview();
            }
            renderThumbs('edit');
            
            // 打开模态框
            openModal('edit-item-modal');
        }

        // 更新商品
        function updateItem() {
            const itemId = document.getElementById('edit-item-id').value;
            const categoryId = document.getElementById('edit-item-category').value;
            const name = document.getElementById('edit-item-name').value.trim();
            const currency = document.getElementById('edit-item-currency').value;
            const denomination = document.getElementById('edit-item-denomination').value.trim();
            const collectionTypeInput = document.getElementById('edit-item-collection-type').value.trim();
            const serialNumber = document.getElementById('edit-item-serial-number').value.trim();
            const notes = document.getElementById('edit-item-notes').value.trim();
            
            // 验证必填字段
            if (!categoryId || !name || !currency || !denomination || !collectionTypeInput || !serialNumber) {
                showToast('请填写所有必填字段', 'error');
                return;
            }
            
            // 查找商品
            const itemIndex = collectionItems.findIndex(item => item.id === itemId);
            
            if (itemIndex === -1) {
                showToast('商品不存在', 'error');
                return;
            }
            
            let collectionTypeId;
            const existingType = collectionTypes.find(type => type.name === collectionTypeInput && type.categoryId === categoryId);
            if (existingType) {
                collectionTypeId = existingType.id;
            } else {
                const newCollectionType = { id: 'type-' + Date.now(), name: collectionTypeInput, categoryId: categoryId };
                collectionTypes.push(newCollectionType);
                saveCollectionTypes();
                collectionTypeId = newCollectionType.id;
            }
            
            // 获取图片URL
            const editPreviewImage = document.getElementById('edit-preview-image');
            const imageUrl = editPreviewImage.classList.contains('hidden') ? null : editPreviewImage.src;
            
            // 更新商品
            collectionItems[itemIndex] = {
                ...collectionItems[itemIndex],
                categoryId: categoryId,
                name: name,
                currency: currency,
                denomination: denomination,
                collectionTypeId: collectionTypeId,
                serialNumber: serialNumber,
                imageUrl: imageUrl,
                imageUrls: editItemImages && editItemImages.length ? [...editItemImages] : (imageUrl ? [imageUrl] : []),
                notes: notes
            };
            
            saveCollectionItems();
            
            // 更新商品列表
            renderItems();
            renderCategories();
            updateTotalCount();
            
            // 关闭模态框
            closeModal('edit-item-modal');
            
            // 重置表单
            document.getElementById('edit-item-form').reset();
            resetEditImagePreview();
            
            // 显示成功提示
            showToast('商品更新成功');
        }

        // 打开确认删除模态框
        function openConfirmDeleteModal(itemId) {
            const item = collectionItems.find(item => item.id === itemId);
            
            if (!item) return;
            
            currentItemId = itemId;
            
            // 显示商品名称
            document.getElementById('delete-item-name').textContent = item.name;
            
            // 打开模态框
            openModal('confirm-delete-modal');
        }

        // 删除商品
        function deleteItem(itemId) {
            const itemIndex = collectionItems.findIndex(item => item.id === itemId);
            
            if (itemIndex === -1) {
                showToast('商品不存在', 'error');
                return;
            }
            
            // 删除商品
            collectionItems.splice(itemIndex, 1);
            saveCollectionItems();
            
            // 更新商品列表
            renderItems();
            renderCategories();
            updateTotalCount();
            
            // 关闭模态框
            closeModal('confirm-delete-modal');
            
            // 显示成功提示
            showToast('商品删除成功');
        }

        // 处理图片上传
        let addItemImages = [];
        let editItemImages = [];

        function handleImagesUpload(mode, files) {
            const list = mode === 'add' ? addItemImages : editItemImages;
            const placeholderId = mode === 'add' ? 'preview-placeholder' : 'edit-preview-placeholder';
            const previewId = mode === 'add' ? 'preview-image' : 'edit-preview-image';
            const containerId = mode === 'add' ? 'image-preview' : 'edit-image-preview';
            const thumbsId = mode === 'add' ? 'preview-thumbs' : 'edit-preview-thumbs';
            const maxCount = 3;
            const available = maxCount - list.length;
            const incoming = files.slice(0, available);
            if (files.length > available) {
                showToast(`最多可上传${maxCount}张图片`, 'error');
            }
            const placeholder = document.getElementById(placeholderId);
            const preview = document.getElementById(previewId);
            const container = document.getElementById(containerId);
            const removeImageBtn = container.querySelector('.remove-image');
            let processed = 0;
            incoming.forEach(file => {
                if (!file.type.match('image.*')) return;
                if (file.size > 5 * 1024 * 1024) { showToast('图片大小不能超过5MB', 'error'); return; }
                const reader = new FileReader();
                reader.onload = function(e) {
                    list.push(e.target.result);
                    processed++;
                    if (processed === incoming.length) {
                        if (list.length > 0) {
                            placeholder.classList.add('hidden');
                            preview.src = list[0];
                            preview.classList.remove('hidden');
                            container.classList.add('has-image');
                            removeImageBtn.classList.remove('hidden');
                        }
                        renderThumbs(mode);
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        function renderThumbs(mode) {
            const list = mode === 'add' ? addItemImages : editItemImages;
            const thumbsId = mode === 'add' ? 'preview-thumbs' : 'edit-preview-thumbs';
            const thumbs = document.getElementById(thumbsId);
            if (!thumbs) return;
            thumbs.innerHTML = '';
            list.forEach((src, idx) => {
                const wrap = document.createElement('div');
                wrap.className = 'relative border rounded overflow-hidden h-20';
                wrap.innerHTML = `
                    <img src="${src}" class="w-full h-full object-cover" />
                    <button class="absolute top-1 right-1 bg-white bg-opacity-80 text-red-600 rounded-full w-6 h-6 flex items-center justify-center" data-index="${idx}"><i class="fa fa-times"></i></button>
                `;
                thumbs.appendChild(wrap);
            });
            thumbs.querySelectorAll('button[data-index]').forEach(btn => {
                btn.addEventListener('click', function(){
                    const i = parseInt(this.getAttribute('data-index'), 10);
                    if (mode === 'add') { addItemImages.splice(i, 1); } else { editItemImages.splice(i, 1); }
                    const placeholderId = mode === 'add' ? 'preview-placeholder' : 'edit-preview-placeholder';
                    const previewId = mode === 'add' ? 'preview-image' : 'edit-preview-image';
                    const containerId = mode === 'add' ? 'image-preview' : 'edit-image-preview';
                    const placeholder = document.getElementById(placeholderId);
                    const preview = document.getElementById(previewId);
                    const container = document.getElementById(containerId);
                    if (list.length === 0) {
                        placeholder.classList.remove('hidden');
                        preview.src = '';
                        preview.classList.add('hidden');
                        container.classList.remove('has-image');
                        const removeImageBtn = container.querySelector('.remove-image');
                        if (removeImageBtn) removeImageBtn.classList.add('hidden');
                    } else {
                        preview.src = list[0];
                    }
                    renderThumbs(mode);
                });
            });
        }

        // 移除图片
        function removeImage() {
            addItemImages = [];
            resetImagePreview();
            renderThumbs('add');
        }

        // 移除编辑图片
        function removeEditImage() {
            editItemImages = [];
            resetEditImagePreview();
            renderThumbs('edit');
        }

        // 重置图片预览
        function resetImagePreview() {
            const previewPlaceholder = document.getElementById('preview-placeholder');
            const previewImage = document.getElementById('preview-image');
            const imagePreview = document.getElementById('image-preview');
            const removeImageBtn = imagePreview.querySelector('.remove-image');
            
            previewPlaceholder.classList.remove('hidden');
            previewImage.src = '';
            previewImage.classList.add('hidden');
            imagePreview.classList.remove('has-image');
            removeImageBtn.classList.add('hidden');
            document.getElementById('item-image').value = '';
        }

        // 重置编辑图片预览
        function resetEditImagePreview() {
            const editPreviewPlaceholder = document.getElementById('edit-preview-placeholder');
            const editPreviewImage = document.getElementById('edit-preview-image');
            const editImagePreview = document.getElementById('edit-image-preview');
            const removeImageBtn = editImagePreview.querySelector('.remove-image');
            
            editPreviewPlaceholder.classList.remove('hidden');
            editPreviewImage.src = '';
            editPreviewImage.classList.add('hidden');
            editImagePreview.classList.remove('has-image');
            removeImageBtn.classList.add('hidden');
            document.getElementById('edit-item-image').value = '';
        }

        // 打开模态框
        function openModal(modalId) {
            try {
                console.log('Opening modal:', modalId);
                const modal = document.getElementById(modalId);
                if (!modal) {
                    console.error('Modal not found:', modalId);
                    return;
                }
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                console.log('Modal opened successfully:', modalId);
                if (modalId === 'add-item-modal') {
                    const autoChk = document.getElementById('auto-code');
                    const codeInput = document.getElementById('item-code');
                    if (autoChk && codeInput) {
                        autoChk.checked = true;
                        codeInput.value = getNextItemCode();
                    }
                }
            } catch (e) {
                console.error('Error opening modal:', e);
            }
        }

        // 关闭模态框
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('hidden');
            document.body.style.overflow = '';
            
            // 隐藏收藏类型建议
            if (modalId === 'add-item-modal') {
                document.getElementById('type-suggestions').classList.add('hidden');
            } else if (modalId === 'edit-item-modal') {
                document.getElementById('edit-type-suggestions').classList.add('hidden');
            }
        }

        // 显示提示
        function showToast(message, type = 'success') {
            const toast = document.getElementById('success-toast');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.textContent = message;
            
            if (type === 'error') {
                toast.classList.remove('bg-green-500');
                toast.classList.add('bg-red-500');
            } else {
                toast.classList.remove('bg-red-500');
                toast.classList.add('bg-green-500');
            }
            
            toast.classList.remove('translate-y-10', 'opacity-0');
            
            setTimeout(() => {
                toast.classList.add('translate-y-10', 'opacity-0');
            }, 3000);
        }

        // 更新总数量
        function updateTotalCount() {
            const totalCount = document.getElementById('total-count');
            totalCount.textContent = collectionItems.length;
        }

        // 获取分类
        function getCategory(categoryId) {
            return categories.find(category => category.id === categoryId) || null;
        }

        // 获取收藏类型
        function getCollectionType(typeId) {
            return collectionTypes.find(type => type.id === typeId) || null;
        }

        // 获取收藏类型名称
        function getCollectionTypeName(typeId) {
            const type = getCollectionType(typeId);
            return type ? type.name : '未分类';
        }
        function getPrimaryImage(item) {
            if (Array.isArray(item.imageUrls) && item.imageUrls.length) return item.imageUrls[0];
            return item.imageUrl || null;
        }

        // 格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // 保存分类数据
        function saveCategories() {
            localStorage.setItem('collection_categories', JSON.stringify(categories));
        }

        // 保存收藏类型数据
        function saveCollectionTypes() {
            localStorage.setItem('collection_types', JSON.stringify(collectionTypes));
        }

        // 保存商品数据
        function saveCollectionItems() {
            localStorage.setItem('collection_items', JSON.stringify(collectionItems));
        }
        let currencies = [];
        function normalizeCurrency(c){
            if (typeof c === 'string') return { code: c, names: { 'zh-CN': c, 'zh-TW': c, 'en': c } };
            if (c && c.code && c.names) return c;
            if (c && c.name) return { code: c.name, names: { 'zh-CN': c.name, 'zh-TW': c.name, 'en': c.name } };
            return null;
        }
        function loadCurrencies() {
            const stored = localStorage.getItem('collection_currencies');
            const raw = stored ? JSON.parse(stored) : [];
            currencies = Array.isArray(raw) ? raw.map(normalizeCurrency).filter(Boolean) : [];
        }
        function saveCurrencies() {
            localStorage.setItem('collection_currencies', JSON.stringify(currencies));
        }
        function getCurrencyLabel(cur){
            const lang = currentLanguage || 'zh-CN';
            const names = cur.names || {};
            return names[lang] || names['zh-CN'] || names['en'] || cur.code;
        }
        function renderCurrencyOptions() {
            const selects = ['item-currency','edit-item-currency','quick-item-currency'];
            selects.forEach(id => {
                const sel = document.getElementById(id);
                if (!sel) return;
                sel.innerHTML = '';
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = '请选择币种';
                sel.appendChild(placeholder);
                currencies.forEach(cur => {
                    const opt = document.createElement('option');
                    opt.value = cur.code;
                    opt.textContent = getCurrencyLabel(cur);
                    sel.appendChild(opt);
                });
            });
        }
        function renderCurrenciesTable() {
            const tbody = document.getElementById('currencies-table-body');
            if (!tbody) return;
            tbody.innerHTML = '';
            currencies.forEach((cur, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="px-4 py-2 text-gray-800">${cur.code}</td><td class="px-4 py-2 text-gray-800">${getCurrencyLabel(cur)}</td><td class="px-4 py-2 text-right"><button data-index="${idx}" class="px-2 py-1 text-red-600 hover:underline">刪除</button></td>`;
                tbody.appendChild(tr);
            });
            tbody.querySelectorAll('button[data-index]').forEach(btn => {
                btn.addEventListener('click', function(){
                    const i = parseInt(this.getAttribute('data-index'),10);
                    currencies.splice(i,1);
                    saveCurrencies();
                    renderCurrenciesTable();
                    renderCurrencyOptions();
                });
            });
            const toggleBtn = document.getElementById('quick-add-currency-btn');
            const formWrap = document.getElementById('quick-add-currency-form');
            const cancelBtn = document.getElementById('cancel-quick-add-currency');
            if (toggleBtn && formWrap) {
                toggleBtn.onclick = function(){ formWrap.classList.toggle('hidden'); };
            }
            if (cancelBtn && formWrap) {
                cancelBtn.onclick = function(){
                    formWrap.classList.add('hidden');
                    ['currency-code-input','currency-zhcn-input','currency-zhtw-input','currency-en-input'].forEach(id=>{ const el=document.getElementById(id); if (el) el.value=''; });
                };
            }
            const form = formWrap ? formWrap.querySelector('form') : null;
            if (form) {
                form.onsubmit = function(e){
                    e.preventDefault();
                    const codeEl = document.getElementById('currency-code-input');
                    const zhcnEl = document.getElementById('currency-zhcn-input');
                    const zhtwEl = document.getElementById('currency-zhtw-input');
                    const enEl = document.getElementById('currency-en-input');
                    const code = codeEl ? codeEl.value.trim().toUpperCase() : '';
                    const zhcn = zhcnEl ? zhcnEl.value.trim() : '';
                    const zhtw = zhtwEl ? zhtwEl.value.trim() : '';
                    const en = enEl ? enEl.value.trim() : '';
                    if (!code) { showToast('請輸入幣種代碼','error'); return; }
                    if (currencies.some(c=>c.code===code)) { showToast('代碼已存在','error'); return; }
                    currencies.push({ code, names: { 'zh-CN': zhcn || code, 'zh-TW': zhtw || zhcn || code, 'en': en || code } });
                    saveCurrencies();
                    renderCurrenciesTable();
                    renderCurrencyOptions();
                    ['currency-code-input','currency-zhcn-input','currency-zhtw-input','currency-en-input'].forEach(id=>{ const el=document.getElementById(id); if (el) el.value=''; });
                    formWrap.classList.add('hidden');
                };
            }
        }
        
        function saveBudgets() {
            localStorage.setItem('collection_budgets', JSON.stringify(budgets));
        }

        function getNextItemCode() {
            const stored = localStorage.getItem('next_item_code');
            if (stored) {
                const num = parseInt(stored, 10) || 1;
                return String(num).padStart(2, '0');
            }
            let max = 0;
            collectionItems.forEach(it => {
                if (it.code && /^\d+$/.test(it.code)) {
                    const n = parseInt(it.code, 10);
                    if (!isNaN(n)) max = Math.max(max, n);
                }
            });
            const next = max + 1;
            return String(next).padStart(2, '0');
        }

        function incrementNextItemCode(currentCode) {
            const num = parseInt(currentCode, 10);
            const next = isNaN(num) ? 1 : num + 1;
            localStorage.setItem('next_item_code', String(next));
        }
        
        // 渲染分类表格
        function renderCategoriesTable() {
            const categoriesTableBody = document.getElementById('categories-table-body');
            categoriesTableBody.innerHTML = '';
            
            if (categories.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="4" class="px-4 py-4 text-center text-gray-500">暂无分类</td>
                `;
                categoriesTableBody.appendChild(emptyRow);
                return;
            }
            
            categories.forEach(category => {
                const itemCount = collectionItems.filter(item => item.categoryId === category.id).length;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="font-medium text-gray-900">${category.name}</div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="text-sm text-gray-500">${category.description || '无描述'}</div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="text-sm text-gray-500">${itemCount}</div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-red-600 hover:text-red-900 delete-category-btn" data-id="${category.id}">
                            删除
                        </button>
                    </td>
                `;
                
                // 添加删除按钮事件
                const deleteBtn = row.querySelector('.delete-category-btn');
                deleteBtn.addEventListener('click', function() {
                    const categoryId = this.getAttribute('data-id');
                    const category = categories.find(c => c.id === categoryId);
                    
                    if (itemCount > 0) {
                        showToast('该分类下还有商品，无法删除', 'error');
                        return;
                    }
                    
                    // 打开确认删除模态框
                    document.getElementById('delete-item-name').textContent = category.name;
                    currentItemId = categoryId;
                    openModal('confirm-delete-modal');
                    
                    // 重新绑定确认删除按钮事件
                    document.getElementById('confirm-delete-btn').onclick = function() {
                        deleteCategory(categoryId);
                    };
                });
                
                categoriesTableBody.appendChild(row);
            });
        }
        
        // 渲染商品表格
        function renderItemsTable() {
            const itemsTableBody = document.getElementById('items-table-body');
            const filterCategory = document.getElementById('filter-by-category').value;
            
            itemsTableBody.innerHTML = '';
            
            // 筛选商品
            let filteredItems = collectionItems;
            if (filterCategory !== 'all') {
                filteredItems = filteredItems.filter(item => item.categoryId === filterCategory);
            }
            
            if (filteredItems.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="5" class="px-4 py-4 text-center text-gray-500">暂无商品</td>
                `;
                itemsTableBody.appendChild(emptyRow);
                return;
            }
            
            filteredItems.forEach(item => {
                const category = getCategory(item.categoryId);
                const collectionType = getCollectionType(item.collectionTypeId);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="font-medium text-gray-900">${item.name}</div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="text-sm text-gray-500">${category ? category.name : '未分类'}</div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="text-sm text-gray-500">${collectionType ? collectionType.name : '未分类'}</div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="text-sm text-gray-500">${item.serialNumber}</div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-red-600 hover:text-red-900 delete-item-btn" data-id="${item.id}">
                            删除
                        </button>
                    </td>
                `;
                
                // 添加删除按钮事件
                const deleteBtn = row.querySelector('.delete-item-btn');
                deleteBtn.addEventListener('click', function() {
                    const itemId = this.getAttribute('data-id');
                    const item = collectionItems.find(i => i.id === itemId);
                    
                    // 打开确认删除模态框
                    document.getElementById('delete-item-name').textContent = item.name;
                    currentItemId = itemId;
                    openModal('confirm-delete-modal');
                    
                    // 重新绑定确认删除按钮事件
                    document.getElementById('confirm-delete-btn').onclick = function() {
                        deleteItem(itemId);
                    };
                });
                
                itemsTableBody.appendChild(row);
            });
        }
        
        // 渲染收藏类型表格
        function renderTypesTable() {
            const typesTableBody = document.getElementById('types-table-body');
            if (!typesTableBody) return;
            typesTableBody.innerHTML = '';
            
            if (collectionTypes.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="4" class="px-4 py-4 text-center text-gray-500">暂无收藏类型</td>
                `;
                typesTableBody.appendChild(emptyRow);
                return;
            }
            
            collectionTypes.forEach(type => {
                const category = getCategory(type.categoryId);
                const itemCount = collectionItems.filter(item => item.collectionTypeId === type.id).length;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="font-medium text-gray-900">${type.name}</div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="text-sm text-gray-500">${category ? category.name : '未分类'}</div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="text-sm text-gray-500">${itemCount}</div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-red-600 hover:text-red-900 delete-type-btn" data-id="${type.id}">删除</button>
                    </td>
                `;
                
                const deleteBtn = row.querySelector('.delete-type-btn');
                deleteBtn.addEventListener('click', function() {
                    const typeId = this.getAttribute('data-id');
                    const linkedCount = collectionItems.filter(item => item.collectionTypeId === typeId).length;
                    if (linkedCount > 0) {
                        showToast('该类型下还有商品，无法删除', 'error');
                        return;
                    }
                    deleteCollectionType(typeId);
                });
                
                typesTableBody.appendChild(row);
            });
        }

        function renderExpenseCategoriesTable() {
            const body = document.getElementById('expense-cats-table-body');
            if (!body) return;
            body.innerHTML = '';
            if (expenseCategories.length === 0) {
                const empty = document.createElement('tr');
                empty.innerHTML = `<td colspan="2" class="px-4 py-8 text-center text-gray-500">暂无分类</td>`;
                body.appendChild(empty);
                return;
            }
            expenseCategories.forEach(c => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap"><div class="font-medium text-gray-900">${c.name}</div></td>
                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-red-600 hover:text-red-900 del-expense-cat" data-id="${c.id}">删除</button>
                    </td>
                `;
                row.querySelector('.del-expense-cat').addEventListener('click', function(){
                    const id = this.getAttribute('data-id');
                    const item = expenseCategories.find(x => x.id === id);
                    const used = transactions.some(t => t.type === 'expense' && t.category === (item ? item.name : ''));
                    if (used) { showToast('该分类已有记录，无法删除', 'error'); return; }
                    expenseCategories = expenseCategories.filter(x => x.id !== id);
                    saveExpenseCategories();
                    renderExpenseCategoriesTable();
                });
                body.appendChild(row);
            });
        }

        function renderIncomeCategoriesTable() {
            const body = document.getElementById('income-cats-table-body');
            if (!body) return;
            body.innerHTML = '';
            if (incomeCategories.length === 0) {
                const empty = document.createElement('tr');
                empty.innerHTML = `<td colspan="2" class="px-4 py-8 text-center text-gray-500">暂无分类</td>`;
                body.appendChild(empty);
                return;
            }
            incomeCategories.forEach(c => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap"><div class="font-medium text-gray-900">${c.name}</div></td>
                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-red-600 hover:text-red-900 del-income-cat" data-id="${c.id}">删除</button>
                    </td>
                `;
                row.querySelector('.del-income-cat').addEventListener('click', function(){
                    const id = this.getAttribute('data-id');
                    const item = incomeCategories.find(x => x.id === id);
                    const used = transactions.some(t => t.type === 'income' && t.category === (item ? item.name : ''));
                    if (used) { showToast('该分类已有记录，无法删除', 'error'); return; }
                    incomeCategories = incomeCategories.filter(x => x.id !== id);
                    saveIncomeCategories();
                    renderIncomeCategoriesTable();
                });
                body.appendChild(row);
            });
        }

        function renderBudgetsTable() {
            const body = document.getElementById('budgets-table-body');
            if (!body) return;
            body.innerHTML = '';
            if (budgets.length === 0) {
                const empty = document.createElement('tr');
                empty.innerHTML = `<td colspan="4" class="px-4 py-8 text-center text-gray-500">${translations[currentLanguage].noBudgets || '暂无预算'}</td>`;
                body.appendChild(empty);
                return;
            }
            budgets.forEach(b => {
                const row = document.createElement('tr');
                const initial = parseFloat(b.initialAmount || b.amount) || 0;
                const current = parseFloat(b.amount) || 0;
                const used = Math.max(0, initial - current);
                const percent = initial > 0 ? Math.min(100, Math.max(0, (used / initial) * 100)) : 0;
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap"><div class="font-medium text-gray-900">${b.name}</div></td>
                    <td class="px-4 py-3 whitespace-nowrap"><div class="text-sm text-gray-500">${b.type}</div></td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="text-sm text-gray-500 mb-1">${percent.toFixed(0)}%</div>
                        <div class="w-48 bg-gray-200 rounded-full h-2">
                            <div class="bg-primary h-2 rounded-full" style="width: ${percent}%"></div>
                        </div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-red-600 hover:text-red-900 delete-budget-btn" data-id="${b.id}">${translations[currentLanguage].delete || '删除'}</button>
                    </td>
                `;
                const del = row.querySelector('.delete-budget-btn');
                del.addEventListener('click', function(){
                    const id = this.getAttribute('data-id');
                    const used = transactions.some(t => t.budgetId === id);
                    if (used) {
                        showToast(translations[currentLanguage].budgetInUse || '该预算已有关联记录，无法删除', 'error');
                        return;
                    }
                    budgets = budgets.filter(x => x.id !== id);
                    saveBudgets();
                    renderBudgetsTable();
                });
                body.appendChild(row);
            });
        }
        
        function renderBudgetOptions() {
            const sel = document.getElementById('transaction-budget');
            if (!sel) return;
            sel.innerHTML = `<option value="">${translations[currentLanguage].selectBudgetType || '请选择预算类型'}</option>`;
            budgets.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b.id;
                opt.textContent = b.type;
                sel.appendChild(opt);
            });
        }

        function applyDisplayMode() {
            const mode = localStorage.getItem('display_mode') || 'desktop';
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const hamburger = document.getElementById('hamburger-btn');
            if (!sidebar || !overlay || !hamburger) return;
            if (mode === 'mobile') {
                hamburger.classList.remove('hidden');
                sidebar.classList.add('fixed','inset-y-0','left-0','transform','-translate-x-full','transition-transform','duration-300','ease-in-out','z-50');
                sidebar.classList.remove('hidden');
                overlay.classList.add('hidden');
                hamburger.onclick = openSidebar;
                overlay.onclick = closeSidebar;
            } else {
                hamburger.classList.add('hidden');
                sidebar.classList.remove('fixed','inset-y-0','left-0','transform','-translate-x-full','transition-transform','duration-300','ease-in-out','z-50');
                overlay.classList.add('hidden');
                // 还原为桌面侧栏：小屏隐藏，md及以上显示
                if (!sidebar.classList.contains('md:block')) sidebar.classList.add('md:block');
                if (!sidebar.classList.contains('hidden')) sidebar.classList.add('hidden');
            }
        }

        function openSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if (!sidebar || !overlay) return;
            sidebar.classList.remove('-translate-x-full');
            overlay.classList.remove('hidden');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if (!sidebar || !overlay) return;
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('hidden');
        }

        function initSwipeGestures() {
            const mode = localStorage.getItem('display_mode') || 'desktop';
            if (mode !== 'mobile') return;
            let startX = 0; let startY = 0; let touching = false;
            document.addEventListener('touchstart', function(e){
                const t = e.touches[0]; startX = t.clientX; startY = t.clientY; touching = true;
            }, { passive: true });
            document.addEventListener('touchend', function(e){
                if (!touching) return; touching = false;
                const t = e.changedTouches && e.changedTouches[0]; if (!t) return;
                const dx = t.clientX - startX; const dy = Math.abs(t.clientY - startY);
                if (startX < 20 && dx > 60 && dy < 40) { openSidebar(); }
            }, { passive: true });
        }

        function initDisplaySettings() {
            const mode = localStorage.getItem('display_mode') || 'desktop';
            const rDesktop = document.getElementById('display-desktop');
            const rMobile = document.getElementById('display-mobile');
            const saveBtn = document.getElementById('save-display-settings');
            if (rDesktop && rMobile) {
                if (mode === 'mobile') rMobile.checked = true; else rDesktop.checked = true;
            }
            if (saveBtn) {
                saveBtn.onclick = function(){
                    const selected = rMobile && rMobile.checked ? 'mobile' : 'desktop';
                    localStorage.setItem('display_mode', selected);
                    applyDisplayMode();
                    showToast('设置已保存');
                };
            }
        }

        function initAuth() {
            const screen = document.getElementById('login-screen');
            const form = document.getElementById('login-form');
            const pwd = document.getElementById('login-password');
            const toggle = document.getElementById('toggle-password');
            const header = document.getElementById('app-header');
            const main = document.getElementById('app-main');
            const expires = localStorage.getItem('auth_expires');
            const now = Date.now();
            const authed = !!expires && now <= parseInt(expires,10);
            if (!authed) {
                if (screen) screen.classList.remove('hidden');
                if (header) header.classList.add('hidden');
                if (main) main.classList.add('hidden');
            } else {
                if (screen) screen.classList.add('hidden');
                if (header) header.classList.remove('hidden');
                if (main) main.classList.remove('hidden');
            }
            if (toggle && pwd) {
                const show = () => { pwd.type = 'text'; };
                const hide = () => { pwd.type = 'password'; };
                toggle.addEventListener('mousedown', show);
                toggle.addEventListener('mouseup', hide);
                toggle.addEventListener('mouseleave', hide);
                toggle.addEventListener('touchstart', show, { passive: true });
                toggle.addEventListener('touchend', hide, { passive: true });
            }
            if (form) {
                form.addEventListener('submit', function(e){
                    e.preventDefault();
                    const user = document.getElementById('login-username').value.trim();
                    const pass = pwd.value.trim();
                    const remember = document.getElementById('remember-me').checked;
                    if (!user || !pass) { showToast('請輸入名稱與密碼','error'); return; }
                    if (user !== 'CarterChan' || pass !== 'Carter0502') { showToast('名稱或密碼不正確','error'); return; }
                    const exp = remember ? (Date.now() + 3600000) : Date.now();
                    localStorage.setItem('auth_expires', String(exp));
                    if (screen) screen.classList.add('hidden');
                    if (header) header.classList.remove('hidden');
                    if (main) main.classList.remove('hidden');
                    showToast('登入成功');
                });
            }
        }

        function saveExpenseCategories() {
            localStorage.setItem('expense_categories', JSON.stringify(expenseCategories));
        }

        function saveIncomeCategories() {
            localStorage.setItem('income_categories', JSON.stringify(incomeCategories));
        }

        function renderTransactionCategoryOptions(type) {
            const sel = document.getElementById('transaction-category');
            if (!sel) return;
            sel.innerHTML = '<option value="">请选择</option>';
            const source = type === 'income' ? incomeCategories : expenseCategories;
            source.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.name;
                opt.textContent = c.name;
                sel.appendChild(opt);
            });
        }
        
        function showBudgetManageView() {
            const rightPanel = document.getElementById('right-panel');
            const listView = document.getElementById('transactions-list-view');
            const statsView = document.getElementById('statistics-view');
            const budgetView = document.getElementById('budget-view');
            const catView = document.getElementById('category-content');
            const welcomeView = document.getElementById('welcome-screen');
            rightPanel.classList.remove('hidden');
            rightPanel.classList.add('lg:col-span-3');
            listView.classList.add('hidden');
            statsView.classList.add('hidden');
            budgetView.classList.remove('hidden');
            catView.classList.add('hidden');
            welcomeView.classList.add('hidden');
            renderBudgetsTable();
        }
        
        // 删除收藏类型
        function deleteCollectionType(typeId) {
            const index = collectionTypes.findIndex(t => t.id === typeId);
            if (index === -1) {
                showToast('收藏类型不存在', 'error');
                return;
            }
            collectionTypes.splice(index, 1);
            saveCollectionTypes();
            renderTypesTable();
            renderCollectionTypeOptions();
            renderQuickAddItemOptions();
            showToast('收藏类型删除成功');
        }
        
        // 渲染快速添加收藏类型的分类选项
        function renderQuickAddTypeOptions() {
            const select = document.getElementById('quick-type-category');
            if (!select) return;
            select.innerHTML = '';
            if (categories.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '暂无分类，请先添加分类';
                select.appendChild(option);
                return;
            }
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                select.appendChild(option);
            });
        }
        
        // 渲染分类筛选选项
        function renderCategoryFilterOptions() {
            const filterSelect = document.getElementById('filter-by-category');
            
            // 清空现有选项（保留第一个"所有分类"选项）
            while (filterSelect.options.length > 1) {
                filterSelect.remove(1);
            }
            
            // 添加分类选项
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                filterSelect.appendChild(option);
            });
        }
        
        // 渲染快速添加分类选项
        function renderQuickAddCategoryOptions() {
            const categorySelect = document.getElementById('quick-item-category');
            categorySelect.innerHTML = '';
            
            if (categories.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '暂无分类，请先添加分类';
                categorySelect.appendChild(option);
                return;
            }
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });
            
            // 默认选中第一个分类
            if (categories.length > 0) {
                categorySelect.value = categories[0].id;
                // 渲染对应的收藏类型选项
                renderQuickAddItemTypeOptions(categories[0].id);
            }
        }
        
        // 渲染快速添加商品选项
        function renderQuickAddItemOptions() {
            renderQuickAddCategoryOptions();
        }
        
        // 渲染快速添加商品的收藏类型选项
        function renderQuickAddItemTypeOptions(categoryId) {
            const typeSelect = document.getElementById('quick-item-type');
            typeSelect.innerHTML = '';
            
            // 筛选出该分类下的收藏类型
            const filteredTypes = collectionTypes.filter(type => type.categoryId === categoryId);
            
            if (filteredTypes.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '该分类下暂无收藏类型';
                typeSelect.appendChild(option);
                return;
            }
            
            filteredTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type.id;
                option.textContent = type.name;
                typeSelect.appendChild(option);
            });
        }
        
        // 删除分类
        function deleteCategory(categoryId) {
            const categoryIndex = categories.findIndex(category => category.id === categoryId);
            
            if (categoryIndex === -1) {
                showToast('分类不存在', 'error');
                return;
            }
            
            // 检查分类下是否有商品
            const itemCount = collectionItems.filter(item => item.categoryId === categoryId).length;
            if (itemCount > 0) {
                showToast('该分类下还有商品，无法删除', 'error');
                closeModal('confirm-delete-modal');
                return;
            }
            
            // 删除分类
            categories.splice(categoryIndex, 1);
            saveCategories();
            
            // 删除该分类下的收藏类型
            collectionTypes = collectionTypes.filter(type => type.categoryId !== categoryId);
            saveCollectionTypes();
            renderTypesTable();
            renderQuickAddTypeOptions();
            
            // 更新分类表格和下拉选项
            renderCategoriesTable();
            renderCategories();
            renderCategoryFilterOptions();
            renderQuickAddCategoryOptions();
            renderQuickAddItemOptions();
            
            // 关闭模态框
            closeModal('confirm-delete-modal');
            
            // 显示成功提示
            showToast('分类删除成功');
        }

        // 监听分类选择变化，更新收藏类型选项
        document.getElementById('item-category').addEventListener('change', function() {
            renderCollectionTypeOptions();
        });
        
        document.getElementById('edit-item-category').addEventListener('change', function() {
            renderCollectionTypeOptions();
        });
        
        // 绑定交易表单提交事件
        document.getElementById('transaction-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const type = document.getElementById('transaction-type').value;
            const amount = document.getElementById('transaction-amount').value;
            const budgetId = document.getElementById('transaction-budget').value;
            const category = document.getElementById('transaction-category').value;
            const date = document.getElementById('transaction-date').value;
            const note = document.getElementById('transaction-note').value;
            
            if (!budgetId) {
                showToast(translations[currentLanguage].selectBudgetType || '请选择预算类型', 'error');
                return;
            }
            if (!category) {
                showToast('请选择分类', 'error');
                return;
            }
            
            // 创建交易记录对象
            const transaction = {
                id: 'transaction-' + Date.now(),
                type: type,
                amount: amount,
                category: category,
                budgetId: budgetId,
                date: date,
                note: note,
                createdAt: new Date().toISOString()
            };
            
            // 保存交易记录
            transactions.push(transaction);
            localStorage.setItem('collection_transactions', JSON.stringify(transactions));
            const idx = budgets.findIndex(b => b.id === budgetId);
            if (idx !== -1) {
                const delta = parseFloat(amount);
                const current = parseFloat(budgets[idx].amount) || 0;
                budgets[idx].amount = (type === 'income' ? current + delta : current - delta).toFixed(2);
                saveBudgets();
                renderBudgetsTable();
            }
            
            // 关闭模态框
            closeModal('transaction-modal');
            
            // 显示成功提示
            showToast(type === 'income' ? '收入记录保存成功' : '支出记录保存成功');
        });
        
        // 绑定统计周期选择事件
        document.getElementById('statistics-period').addEventListener('change', function() {
            updateStatistics();
        });
        
        // 保存交易记录
        function saveTransaction(transaction) {
            transactions.push(transaction);
            localStorage.setItem('collection_transactions', JSON.stringify(transactions));
        }
        
            function showTransactionModal(type) {
                const titleEl = document.getElementById('transaction-modal-title');
                const typeInput = document.getElementById('transaction-type');
                if (type === 'income') {
                    if (titleEl) titleEl.textContent = '记录收入';
                    if (typeInput) typeInput.value = 'income';
                } else {
                    if (titleEl) titleEl.textContent = '记录支出';
                    if (typeInput) typeInput.value = 'expense';
                }
            renderBudgetOptions();
            renderTransactionCategoryOptions(type);
            openModal('transaction-modal');
        }
        
        // 显示交易记录列表视图
        function showTransactionsListView(type) {
            const rightPanel = document.getElementById('right-panel');
            const statsView = document.getElementById('statistics-view');
            const listView = document.getElementById('transactions-list-view');
            const catView = document.getElementById('category-content');
            const welcomeView = document.getElementById('welcome-screen');
            if (rightPanel) {
                rightPanel.classList.remove('hidden');
                rightPanel.classList.add('lg:col-span-3');
            }
            if (statsView) statsView.classList.add('hidden');
            if (listView) listView.classList.remove('hidden');
            if (catView) catView.classList.add('hidden');
            if (welcomeView) welcomeView.classList.add('hidden');
            const title = document.getElementById('transactions-list-title');
            title.textContent = type === 'expense' ? '支出记录' : '收入记录';
            const addBtn = document.getElementById('add-transaction-btn');
            addBtn.onclick = function() { showTransactionModal(type); };
            updateTransactionsList(type);
        }
        
        // 更新交易记录列表
        function updateTransactionsList(type) {
            // 筛选指定类型的交易记录
            const filteredTransactions = transactions.filter(t => t.type === type);
            
            // 按日期降序排序
            const sortedTransactions = [...filteredTransactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // 渲染交易记录表格
            renderTransactionsListTable(sortedTransactions, type);
        }
        
        // 渲染交易记录列表表格
        function renderTransactionsListTable(transactions, type) {
            const tableBody = document.getElementById('transactions-list-table-body');
            
            // 清空表格
            tableBody.innerHTML = '';
            
            // 添加交易记录行
            transactions.forEach(t => {
                const row = document.createElement('tr');
                
                // 格式化日期
                const date = new Date(t.date).toLocaleDateString('zh-CN');
                
                // 设置行内容
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap">${date}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${t.category}</td>
                    <td class="px-4 py-3 whitespace-nowrap font-medium ${type === 'income' ? 'text-green-600' : 'text-red-600'}">
                        ${type === 'income' ? '+' : '-' }¥${parseFloat(t.amount).toFixed(2)}
                    </td>
                    <td class="px-4 py-3">${t.note || '-'}</td>
                    <td class="px-4 py-3 text-right whitespace-nowrap">
                        <button class="text-red-500 hover:text-red-700 delete-transaction-btn" data-id="${t.id}">
                            <i class="fa fa-trash"></i> 删除
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // 绑定删除按钮事件
            document.querySelectorAll('.delete-transaction-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const transactionId = this.getAttribute('data-id');
                    deleteTransaction(transactionId);
                });
            });
            
            // 如果没有交易记录，显示空状态
            if (transactions.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="5" class="px-4 py-8 text-center text-gray-500">暂无${type === 'expense' ? '支出' : '收入'}记录</td>
                `;
                tableBody.appendChild(emptyRow);
            }
        }
        
        // 删除交易记录
        function deleteTransaction(transactionId) {
            if (confirm('确定要删除这条记录吗？')) {
                const t = transactions.find(x => x.id === transactionId);
                transactions = transactions.filter(tx => tx.id !== transactionId);
                localStorage.setItem('collection_transactions', JSON.stringify(transactions));
                if (t && t.budgetId) {
                    const idx = budgets.findIndex(b => b.id === t.budgetId);
                    if (idx !== -1) {
                        const delta = parseFloat(t.amount);
                        const current = parseFloat(budgets[idx].amount) || 0;
                        budgets[idx].amount = (t.type === 'income' ? current - delta : current + delta).toFixed(2);
                        saveBudgets();
                        renderBudgetsTable();
                    }
                }
                
                // 更新当前视图
                const listView = document.getElementById('transactions-list-view');
                if (!listView.classList.contains('hidden')) {
                    const title = document.getElementById('transactions-list-title').textContent;
                    const type = title.includes('支出') ? 'expense' : 'income';
                    updateTransactionsList(type);
                }
                
                // 如果统计视图可见，也更新统计视图
                const statsView = document.getElementById('statistics-view');
                if (!statsView.classList.contains('hidden')) {
                    updateStatistics();
                }
                
                showToast('记录删除成功');
            }
        }
        
        // 显示统计分析视图
        function showStatisticsView() {
            const rightPanel = document.getElementById('right-panel');
            const statsView = document.getElementById('statistics-view');
            const listView = document.getElementById('transactions-list-view');
            const catView = document.getElementById('category-content');
            const welcomeView = document.getElementById('welcome-screen');
            if (rightPanel) {
                rightPanel.classList.remove('hidden');
                rightPanel.classList.add('lg:col-span-3');
            }
            if (listView) listView.classList.add('hidden');
            if (statsView) statsView.classList.remove('hidden');
            if (catView) catView.classList.add('hidden');
            if (welcomeView) welcomeView.classList.add('hidden');
            updateStatistics();
        }
        
        // 更新统计数据
        function updateStatistics() {
            const period = document.getElementById('statistics-period').value;
            const now = new Date();
            let filteredTransactions = transactions;
            
            // 根据选择的时间段筛选交易记录
            if (period === 'month') {
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                filteredTransactions = transactions.filter(t => new Date(t.date) >= startOfMonth);
            } else if (period === 'year') {
                const startOfYear = new Date(now.getFullYear(), 0, 1);
                filteredTransactions = transactions.filter(t => new Date(t.date) >= startOfYear);
            }
            
            // 计算总收入、总支出和结余
            let totalIncome = 0;
            let totalExpense = 0;
            
            filteredTransactions.forEach(t => {
                if (t.type === 'income') {
                    totalIncome += parseFloat(t.amount);
                } else {
                    totalExpense += parseFloat(t.amount);
                }
            });
            
            const balance = totalIncome - totalExpense;
            
            // 更新统计卡片
            document.getElementById('total-income').textContent = `¥${totalIncome.toFixed(2)}`;
            document.getElementById('total-expense').textContent = `¥${totalExpense.toFixed(2)}`;
            document.getElementById('total-balance').textContent = `¥${balance.toFixed(2)}`;
            
            // 更新最近交易记录表格
            renderRecentTransactionsTable(filteredTransactions);
        }
        
        // 渲染最近交易记录表格
        function renderRecentTransactionsTable(transactions) {
            const tableBody = document.getElementById('recent-transactions-table-body');
            
            // 按日期降序排序，并只显示最近10条记录
            const sortedTransactions = [...transactions]
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 10);
            
            // 清空表格
            tableBody.innerHTML = '';
            
            // 添加交易记录行
            sortedTransactions.forEach(t => {
                const row = document.createElement('tr');
                
                // 格式化日期
                const date = new Date(t.date).toLocaleDateString('zh-CN');
                
                // 设置行内容
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap">${date}</td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${t.type === 'income' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${t.type === 'income' ? '收入' : '支出'}
                        </span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">${t.category}</td>
                    <td class="px-4 py-3 whitespace-nowrap font-medium ${t.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                        ${t.type === 'income' ? '+' : '-' }¥${parseFloat(t.amount).toFixed(2)}
                    </td>
                    <td class="px-4 py-3">${t.note || '-'}</td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // 如果没有交易记录，显示空状态
            if (sortedTransactions.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="5" class="px-4 py-8 text-center text-gray-500">暂无交易记录</td>
                `;
                tableBody.appendChild(emptyRow);
            }
        }
    </script>
</body>
</html>

